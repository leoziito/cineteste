<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineRave - Real</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #080808; color: #fff; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .hero-gradient { background-image: linear-gradient(to top, rgba(8,8,8,1) 0%, rgba(8,8,8,0.8) 20%, rgba(8,8,8,0) 60%, rgba(8,8,8,0.9) 100%); }
        .header-scrolled { background-color: rgba(8, 8, 8, 0.85); backdrop-filter: blur(10px); }
        .nav-icon-active svg, .nav-icon-active span { color: #e50914; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .page { animation: fadeIn 0.3s ease-in-out; }
        .modal-fade-in { animation: fadeIn 0.3s ease-out; }
        .modal-slide-up { animation: slideUp 0.3s ease-out forwards; }
        .toast-show { transform: translateY(0); opacity: 1; }
        .skeleton { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; background-color: #1f2937; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-gray-900">

<!-- Tela de Autenticação -->
<div id="auth-page" class="fixed inset-0 bg-gray-900 z-50 flex items-center justify-center p-4">
    <div class="w-full max-w-sm mx-auto bg-gray-800 p-8 rounded-lg shadow-lg">
        <h1 class="text-3xl font-black text-red-600 tracking-wider text-center mb-6">CINERAVE</h1>
        <div id="auth-error" class="text-red-400 text-sm text-center mb-4 hidden"></div>
        <input id="auth-email" type="email" placeholder="E-mail" class="w-full bg-gray-700 border-none rounded-md px-4 py-3 mb-4 text-white placeholder-gray-400 focus:ring-2 focus:ring-red-600">
        <input id="auth-password" type="password" placeholder="Senha" class="w-full bg-gray-700 border-none rounded-md px-4 py-3 mb-6 text-white placeholder-gray-400 focus:ring-2 focus:ring-red-600">
        <button id="login-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-md transition mb-3">Entrar</button>
        <button id="register-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-md transition">Criar Conta</button>
    </div>
</div>

<!-- Conteúdo Principal -->
<div id="app" class="hidden pb-24">
    <!-- Cabeçalho Fixo -->
    <header id="main-header" class="fixed top-0 left-0 right-0 z-40 p-4 transition-all duration-300">
        <div class="flex justify-between items-center">
            <h1 class="text-2xl font-black text-red-600 tracking-wider">CINERAVE</h1>
            <button id="profile-icon-btn" class="w-8 h-8 bg-gray-700 rounded-full flex items-center justify-center overflow-hidden">
                <svg class="w-6 h-6 text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
            </button>
        </div>
    </header>

    <!-- Container de Páginas -->
    <div id="pages-container" class="min-h-screen"></div>
</div>

<!-- Navegação Inferior -->
<nav id="main-nav" class="hidden fixed bottom-0 left-0 right-0 bg-black bg-opacity-90 backdrop-blur-md border-t border-gray-800 p-2 justify-around items-center z-40">
    <button data-page="home" class="nav-icon flex flex-col items-center text-gray-400 w-1/4"><svg class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><span class="text-xs">Início</span></button>
    <button data-page="search" class="nav-icon flex flex-col items-center text-gray-400 w-1/4"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg><span class="text-xs">Buscar</span></button>
    <button data-page="my-list" class="nav-icon flex flex-col items-center text-gray-400 w-1/4"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg><span class="text-xs">Minha Lista</span></button>
    <button id="admin-nav-btn" data-page="admin" class="nav-icon hidden flex-col items-center text-gray-400 w-1/4"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg><span class="text-xs">Admin</span></button>
</nav>

<!-- Modal -->
<div id="details-modal" class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm z-50 flex items-end justify-center hidden modal-fade-in">
    <div id="modal-content-wrapper" class="bg-gray-900 w-full max-h-[90vh] rounded-t-2xl overflow-y-auto modal-slide-up no-scrollbar"></div>
</div>

<!-- Toast -->
<div id="toast-notification" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-white text-black text-sm font-semibold py-2 px-4 rounded-full shadow-lg transform translate-y-20 opacity-0 transition-all duration-300"></div>

<!-- Firebase + TMDB Script -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, onSnapshot, deleteDoc, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- CONFIGURAÇÃO FIREBASE ---
const firebaseConfig = {
    apiKey: "SUA_API_KEY",
    authDomain: "SEU_AUTH_DOMAIN",
    projectId: "SEU_PROJECT_ID",
    storageBucket: "SEU_STORAGE_BUCKET",
    messagingSenderId: "SEU_MESSAGING_SENDER_ID",
    appId: "SEU_APP_ID"
};
const ADMIN_UID = "SEU_UID_DE_ADMINISTRADOR";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- TMDB ---
const TMDB_API_KEY = "d0f7e2c414b1efff7b000ae9b681ed1b";
const TMDB_BASE_URL = "https://api.themoviedb.org/3";

async function searchTMDB(query, type="movie") {
    if (!query) return [];
    const res = await fetch(`${TMDB_BASE_URL}/search/${type}?api_key=${TMDB_API_KEY}&language=pt-BR&query=${encodeURIComponent(query)}`);
    const data = await res.json();
    return data.results || [];
}

async function getDetailsTMDB(id, type="movie") {
    const res = await fetch(`${TMDB_BASE_URL}/${type}/${id}?api_key=${TMDB_API_KEY}&language=pt-BR`);
    return await res.json();
}

// --- ELEMENTOS ---
const authPage = document.getElementById('auth-page');
const appContainer = document.getElementById('app');
const mainNav = document.getElementById('main-nav');
const pagesContainer = document.getElementById('pages-container');
const mainHeader = document.getElementById('main-header');
const modal = document.getElementById('details-modal');
const modalContentWrapper = document.getElementById('modal-content-wrapper');
const navButtons = document.querySelectorAll('.nav-icon');
const toast = document.getElementById('toast-notification');
const profileIconButton = document.getElementById('profile-icon-btn');

let allPosts = [];
let myList = [];
let currentUser = null;

function showToast(message) {
    toast.textContent = message;
    toast.classList.add('toast-show');
    setTimeout(() => toast.classList.remove('toast-show'), 3000);
}

// --- AUTENTICAÇÃO ---
onAuthStateChanged(auth, user => {
    currentUser = user;
    if(user){
        authPage.classList.add('hidden');
        appContainer.classList.remove('hidden');
        mainNav.style.display = 'flex';
        if(user.uid === ADMIN_UID) document.getElementById('admin-nav-btn').classList.remove('hidden');
        initApp();
    } else {
        authPage.classList.remove('hidden');
        appContainer.classList.add('hidden');
        mainNav.style.display = 'none';
        allPosts = [];
        myList = [];
    }
});

document.getElementById('login-btn').addEventListener('click', async () => {
    const email = document.getElementById('auth-email').value;
    const password = document.getElementById('auth-password').value;
    const errorDiv = document.getElementById('auth-error');
    try { await signInWithEmailAndPassword(auth,email,password); errorDiv.classList.add('hidden'); }
    catch(e){ errorDiv.textContent="Email ou senha inválidos."; errorDiv.classList.remove('hidden'); }
});

document.getElementById('register-btn').addEventListener('click', async () => {
    const email = document.getElementById('auth-email').value;
    const password = document.getElementById('auth-password').value;
    const errorDiv = document.getElementById('auth-error');
    if(password.length<6){ errorDiv.textContent="Senha mínima 6 caracteres"; errorDiv.classList.remove('hidden'); return; }
    try{ await createUserWithEmailAndPassword(auth,email,password); errorDiv.classList.add('hidden'); }
    catch(e){ errorDiv.textContent="Erro ao criar conta"; errorDiv.classList.remove('hidden'); }
});

async function logout(){ await signOut(auth); }

// --- FIRESTORE ---
function listenToPosts(){ onSnapshot(collection(db,"posts"), snapshot=>{ allPosts=snapshot.docs.map(doc=>({id:doc.id,...doc.data()})); const page=document.querySelector('.nav-icon-active')?.dataset.page||'home'; navigateTo(page); }); }
function listenToMyList(){ if(!currentUser) return; onSnapshot(doc(db,"users",currentUser.uid), docSnap=>{ myList=docSnap.exists()&&docSnap.data().myList?docSnap.data().myList:[]; const page=document.querySelector('.nav-icon-active')?.dataset.page; if(page==='my-list') navigateTo('my-list'); }); }
async function toggleMyListItem(post){ if(!currentUser) return; const userListDocRef=doc(db,"users",currentUser.uid); let updatedList=[...myList]; const idx=updatedList.indexOf(post.id); if(idx>-1){ updatedList.splice(idx,1); showToast(`${post.title} removido da lista.`); } else { updatedList.push(post.id); showToast(`${post.title} adicionado à lista.`); } myList=updatedList; await setDoc(userListDocRef,{myList:updatedList}); updateAddToListButtonState(post.id); }

// --- UI Helpers ---
const createCarousel=(title,items)=>{ if(!items||items.length===0) return ''; const html=items.map(item=>`<div class="flex-shrink-0 w-32 md:w-40 mr-3 transform hover:scale-105 transition-transform duration-200 cursor-pointer" data-id="${item.id}"><img loading="lazy" src="${item.poster_path}" alt="${item.title}" class="rounded-md w-full h-auto object-cover pointer-events-none" onerror="this.src='https://placehold.co/400x600/1a1a1a/e0e0e0?text=Indispon%C3%ADvel'"></div>`).join(''); return `<div class="space-y-3"><h3 class="text-xl font-bold px-4">${title}</h3><div class="flex overflow-x-auto no-scrollbar pb-2 pl-4">${html}</div></div>`; };
const createGrid=(items)=>{ if(!items||items.length===0) return `<p class="col-span-full text-center text-gray-400">Nenhum item encontrado.</p>`; return items.map(item=>`<div class="relative group cursor-pointer" data-id="${item.id}"><img loading="lazy" src="${item.poster_path}" alt="${item.title}" class="rounded-md w-full h-auto object-cover" onerror="this.src='https://placehold.co/400x600/1a1a1a/e0e0e0?text=Indispon%C3%ADvel'"></div>`).join(''); };

// --- NAVEGAÇÃO ---
async function navigateTo(page){ pagesContainer.style.animation='fadeOut 0.15s ease-in-out'; setTimeout(async()=>{ pagesContainer.innerHTML=''; let newPage=document.createElement('div'); newPage.className='page'; pagesContainer.appendChild(newPage); switch(page){ case'home': await renderHomePage(newPage); break; case'search': await renderSearchPage(newPage); break; case'my-list': await renderMyListPage(newPage); break; case'admin': await renderAdminPage(newPage); break; case'profile': await renderProfilePage(newPage); break; } navButtons.forEach(btn=>btn.classList.toggle('nav-icon-active',btn.dataset.page===page)); pagesContainer.style.animation='fadeIn 0.15s ease-in-out'; window.scrollTo(0,0); },150); }

// --- Páginas ---
async function renderHomePage(container){
    if(allPosts.length===0){ container.innerHTML=`<div class="pt-40 text-center text-gray-400">Nenhum conteúdo foi postado ainda.</div>`; return; }
    const heroItem=allPosts[Math.floor(Math.random()*allPosts.length)];
    const heroHTML=`<div class="relative h-80 md:h-96 w-full"><img src="${heroItem.poster_path}" alt="${heroItem.title}" class="absolute inset-0 w-full h-full object-cover rounded-b-3xl"><div class="absolute inset-0 hero-gradient rounded-b-3xl"></div><div class="absolute bottom-5 left-5"><h2 class="text-3xl font-bold">${heroItem.title}</h2><button class="mt-2 bg-red-600 px-4 py-2 rounded-md" data-id="${heroItem.id}">Detalhes</button></div></div>`;
    const genres=['Ação','Comédia','Drama','Terror','Romance']; // Para exemplo
    let carousels='';
    for(const genre of genres){
        const filtered=allPosts.filter(p=>p.genre?.includes(genre)).slice(0,10);
        if(filtered.length>0) carousels+=createCarousel(genre,filtered);
    }
    container.innerHTML=heroHTML+carousels;
    container.querySelectorAll('[data-id]').forEach(btn=>btn.addEventListener('click',()=>openModal(btn.dataset.id)));
}

async function renderSearchPage(container){
    container.innerHTML=`<div class="pt-20 px-4"><input type="text" id="search-input" placeholder="Buscar filme/série..." class="w-full bg-gray-700 rounded-md px-4 py-3 text-white mb-4"><div id="search-results" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div></div>`;
    const searchInput=document.getElementById('search-input');
    const resultsDiv=document.getElementById('search-results');
    searchInput.addEventListener('input',async()=>{ const query=searchInput.value.trim(); if(!query){ resultsDiv.innerHTML=''; return; } const movies=await searchTMDB(query,'movie'); const series=await searchTMDB(query,'tv'); const combined=[...movies,...series].map(r=>({id:r.id,title:r.title||r.name,poster_path:`https://image.tmdb.org/t/p/w500${r.poster_path}`,genre:r.genre_ids})); resultsDiv.innerHTML=createGrid(combined); resultsDiv.querySelectorAll('[data-id]').forEach(btn=>btn.addEventListener('click',()=>openModal(btn.dataset.id))); });
}

async function renderMyListPage(container){
    const items=allPosts.filter(p=>myList.includes(p.id));
    container.innerHTML=`<div class="pt-20 px-4 grid grid-cols-2 md:grid-cols-4 gap-4">${createGrid(items)}</div>`;
    container.querySelectorAll('[data-id]').forEach(btn=>btn.addEventListener('click',()=>openModal(btn.dataset.id)));
}

async function renderAdminPage(container){
    if(currentUser.uid!==ADMIN_UID){ container.innerHTML='<p class="pt-40 text-center text-red-600">Acesso negado</p>'; return; }
    container.innerHTML=`
    <div class="pt-20 px-4 max-w-xl mx-auto space-y-4">
        <input id="admin-search-title" type="text" placeholder="Buscar no TMDB..." class="w-full bg-gray-700 rounded-md px-4 py-3 text-white">
        <button id="admin-fetch-btn" class="w-full bg-red-600 py-3 rounded-md font-bold">Buscar</button>
        <div id="admin-search-results" class="space-y-2"></div>
    </div>`;
    const searchInput=document.getElementById('admin-search-title');
    const fetchBtn=document.getElementById('admin-fetch-btn');
    const resultsDiv=document.getElementById('admin-search-results');
    fetchBtn.addEventListener('click',async()=>{
        const query=searchInput.value.trim(); if(!query) return;
        const movies=await searchTMDB(query,'movie'); const series=await searchTMDB(query,'tv'); const combined=[...movies,...series];
        resultsDiv.innerHTML='';
        combined.forEach(item=>{
            const div=document.createElement('div'); div.className='bg-gray-700 p-2 rounded-md flex justify-between items-center';
            div.innerHTML=`<span>${item.title||item.name}</span><button class="bg-red-600 px-2 py-1 rounded text-white">Adicionar</button>`;
            div.querySelector('button').addEventListener('click',async()=>{
                const details=await getDetailsTMDB(item.id,item.media_type||'movie');
                await addDoc(collection(db,'posts'),{
                    title:details.title||details.name,
                    poster_path:details.poster_path?`https://image.tmdb.org/t/p/w500${details.poster_path}`:'',
                    overview:details.overview||'',
                    genre:details.genres?.map(g=>g.name)||[]
                });
                showToast(`${details.title||details.name} adicionado ao feed.`);
            });
            resultsDiv.appendChild(div);
        });
    });
}

// --- Modal ---
function openModal(id){
    const item=allPosts.find(p=>p.id==id); if(!item) return;
    modalContentWrapper.innerHTML=`<div class="p-4"><h2 class="text-2xl font-bold mb-2">${item.title}</h2><img src="${item.poster_path}" class="rounded-md w-full mb-2"><p class="mb-2">${item.overview||'Sem descrição.'}</p><button id="add-to-list-btn" class="bg-red-600 px-4 py-2 rounded-md">Adicionar/Remover da lista</button></div>`;
    modal.classList.remove('hidden');
    document.getElementById('add-to-list-btn').addEventListener('click',()=>toggleMyListItem(item));
    updateAddToListButtonState(item.id);
}
function updateAddToListButtonState(postId){
    const btn=document.getElementById('add-to-list-btn');
    if(!btn) return;
    if(myList.includes(postId)){ btn.textContent='Remover da lista'; btn.classList.add('bg-gray-600'); btn.classList.remove('bg-red-600'); }
    else{ btn.textContent='Adicionar à lista'; btn.classList.add('bg-red-600'); btn.classList.remove('bg-gray-600'); }
}
modal.addEventListener('click',(e)=>{ if(e.target===modal) modal.classList.add('hidden'); });

// --- Perfil ---
profileIconButton.addEventListener('click',()=>navigateTo('profile'));
async function renderProfilePage(container){
    container.innerHTML=`<div class="pt-40 text-center space-y-4"><h2 class="text-2xl font-bold">Perfil</h2><p>Email: ${currentUser.email}</p><button id="logout-btn" class="bg-red-600 px-4 py-2 rounded-md">Sair</button></div>`;
    document.getElementById('logout-btn').addEventListener('click',logout);
}

// --- Eventos Navegação ---
navButtons.forEach(btn=>btn.addEventListener('click',()=>navigateTo(btn.dataset.page)));

// --- Inicialização ---
function initApp(){ listenToPosts(); listenToMyList(); navigateTo('home'); }

</script>
</body>
</html>
