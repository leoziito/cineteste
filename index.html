<!DOCTYPE html>
<html lang="pt" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Cinerave</title>
    <!-- Incluindo Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluindo Font Awesome para os ícones -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Estilo para a transição suave do menu lateral */
        #side-menu.hidden {
            transform: translateX(-100%);
        }
        
        #side-menu.visible {
            transform: translateX(0);
        }

        .modal {
            display: none;
        }
        .modal.active {
            display: flex;
        }

        /* Classes de layout para a grade de conteúdo */
        .content-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        @media (min-width: 640px) {
            .content-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (min-width: 768px) {
            .content-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* Ajuste para card principal de lançamento para caber 4 cards por fileira */
        .main-content-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        @media (min-width: 640px) {
            .main-content-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (min-width: 768px) {
            .main-content-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .notification-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #22c55e;
            color: white;
            padding: 1rem 2rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            text-align: center;
        }
        .notification-message.visible {
            opacity: 1;
        }

        /* Estilos para o card de conteúdo */
        .content-card-overlay {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .content-card:hover .content-card-overlay {
            opacity: 1;
        }
        .content-card:active .content-card-overlay {
            opacity: 1; /* Para mobile, o overlay aparece no toque */
        }
        .content-card img {
            transition: transform 0.3s ease-in-out;
        }
        .content-card:hover img {
            transform: scale(1.05);
        }

        /* Animação do esqueleto */
        .skeleton {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 0.5;
            }
            50% {
                opacity: 1;
            }
        }

        /* Estilo para barra de progresso */
        #loading-bar {
            width: 0;
            height: 4px;
            background-color: #3b82f6;
            transition: width 0.3s ease;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 50;
        }
        .notification-item {
            position: relative;
            padding-right: 3rem; /* Aumenta o padding para evitar sobreposição */
        }
        .remove-notification-btn {
            position: absolute;
            bottom: 4px; /* Move o botão para a parte inferior */
            right: 4px;
        }

        .scrolling-wrapper {
            display: flex;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 1rem;
            gap: 1.5rem;
            
        }
        .scrolling-wrapper .content-card {
            flex: 0 0 120px; /* Reduzido para caber 3-4 cards em dispositivos móveis */
        }
        @media (min-width: 640px) {
            .scrolling-wrapper .content-card {
                flex: 0 0 150px;
            }
        }
        
    </style>
    <script>
        // Configuração para usar o modo escuro com a classe 'dark'
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-white text-zinc-900 dark:bg-zinc-900 dark:text-white transition-colors duration-300">
    <!-- Barra de carregamento -->
    <div id="loading-bar"></div>

    <!-- Cabeçalho do App -->
    <header class="sticky top-0 z-40 bg-white dark:bg-zinc-900 p-4 flex items-center justify-between border-b border-gray-200 dark:border-gray-700 transition-colors duration-300">
        <!-- Ícone de Menu (Abre o menu lateral) -->
        <button id="menu-button" aria-label="Abrir menu" class="rounded-full p-2 hover:bg-gray-100 dark:hover:bg-zinc-800 transition-colors text-zinc-900 dark:text-white">
            <i class="fa-solid fa-bars w-6 h-6" aria-hidden="true"></i>
        </button>
        
        <!-- Título Centralizado do App -->
        <span id="app-title" class="flex-grow text-center text-2xl sm:text-3xl font-bold text-zinc-900 dark:text-white">CINERAVE</span>
        
        <!-- Ícones de Ações (Sino, Tema) -->
        <div class="flex items-center space-x-2 sm:space-x-4 text-zinc-900 dark:text-white">
            <!-- Ícone de Notificações (Sino) -->
            <button id="notifications-btn" aria-label="Notificações" class="relative rounded-full p-2 hover:bg-gray-100 dark:hover:bg-zinc-800 transition-colors">
                <i class="fa-solid fa-bell w-6 h-6" aria-hidden="true"></i>
                <span id="notification-badge" class="absolute top-1 right-1 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center hidden">0</span>
            </button>
            <!-- Botão para alternar Tema -->
            <button id="theme-toggle" aria-label="Alternar tema" class="rounded-full p-2 hover:bg-gray-100 dark:hover:bg-zinc-800 transition-colors">
                <i class="fa-solid fa-moon w-6 h-6" aria-hidden="true"></i>
            </button>
        </div>
    </header>

    <!-- Menu de navegação abaixo do cabeçalho -->
    <nav class="sticky top-16 z-30 bg-white dark:bg-zinc-900 transition-colors duration-300">
        <ul class="flex justify-center sm:justify-start overflow-x-auto whitespace-nowrap space-x-4 p-4 text-sm sm:text-base font-semibold">
            <li><button id="nav-home" class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-500 transition-colors relative pb-2 border-b-2 border-transparent">Início</button></li>
            <li><button id="nav-series" class="text-gray-500 hover:text-blue-700 dark:text-gray-400 dark:hover:text-blue-500 transition-colors relative pb-2 border-b-2 border-transparent">Séries</button></li>
            <li><button id="nav-trending" class="text-gray-500 hover:text-blue-700 dark:text-gray-400 dark:hover:text-blue-500 transition-colors relative pb-2 border-b-2 border-transparent">Em Alta</button></li>
        </ul>
    </nav>

    <!-- Menu Lateral (Inicialmente Oculto) -->
    <div id="side-menu-container" class="fixed inset-0 z-50 bg-black bg-opacity-50 hidden">
        <nav id="side-menu" class="h-full w-64 bg-white dark:bg-zinc-800 text-zinc-900 dark:text-white shadow-lg transform -translate-x-full transition-transform duration-300 flex flex-col">
            <!-- Título "Menu" e botão de fechar -->
            <div class="p-4 flex items-center justify-between">
                <h2 class="text-2xl font-bold">Menu</h2>
                <button id="close-menu-button" aria-label="Fechar menu" class="rounded-full p-2 hover:bg-gray-100 dark:hover:bg-zinc-700">
                    <i class="fa-solid fa-times w-6 h-6" aria-hidden="true"></i>
                </button>
            </div>
            <!-- Novo menu do usuário com os itens e ícones corretos e rolagem -->
            <ul class="flex-grow p-4 space-y-2 overflow-y-auto">
                <li>
                    <a href="#" id="home-link" class="flex items-center space-x-3 p-2 rounded-xl hover:bg-gray-100 dark:hover:bg-zinc-700 transition-colors">
                        <i class="fa-solid fa-home w-6 h-6" aria-hidden="true"></i>
                        <span>Início</span>
                    </a>
                </li>
                <li>
                    <a href="#" id="catalog-link" class="flex items-center space-x-3 p-2 rounded-xl hover:bg-gray-100 dark:hover:bg-zinc-700 transition-colors">
                        <i class="fa-solid fa-border-all w-6 h-6" aria-hidden="true"></i>
                        <span>Catálogo</span>
                    </a>
                </li>
                <li>
                    <a href="#" id="my-list-link" class="flex items-center space-x-3 p-2 rounded-xl hover:bg-gray-100 dark:hover:bg-zinc-700 transition-colors">
                        <i class="fa-solid fa-heart w-6 h-6" aria-hidden="true"></i>
                        <span>Minha Lista</span>
                    </a>
                </li>
                 <li>
                    <a href="#" id="surprise-me-link" class="flex items-center space-x-3 p-2 rounded-xl hover:bg-gray-100 dark:hover:bg-zinc-700 transition-colors">
                        <i class="fa-solid fa-dice w-6 h-6" aria-hidden="true"></i>
                        <span>Surpreenda-me</span>
                    </a>
                </li>
                 <li>
                    <a href="#" id="legal-notice-link" class="flex items-center space-x-3 p-2 rounded-xl hover:bg-gray-100 dark:hover:bg-zinc-700 transition-colors">
                        <i class="fa-solid fa-file-contract w-6 h-6" aria-hidden="true"></i>
                        <span>Aviso Legal</span>
                    </a>
                </li>
                 <li>
                    <button id="toggle-recent-session-btn" class="flex items-center space-x-3 p-2 rounded-xl hover:bg-gray-100 dark:hover:bg-zinc-700 transition-colors">
                        <i class="fa-solid fa-history w-6 h-6" aria-hidden="true"></i>
                        <span id="toggle-recent-session-text">Ocultar Sessão Recente</span>
                    </button>
                </li>
                <li>
                    <a href="https://chat.whatsapp.com/Lidb3f8U9SsDe10kiLVICR" target="_blank" class="flex items-center space-x-3 p-2 rounded-xl hover:bg-gray-100 dark:hover:bg-zinc-700 transition-colors">
                        <i class="fa-brands fa-whatsapp w-6 h-6" aria-hidden="true"></i>
                        <span>Faça seu pedido</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="admin-link flex items-center space-x-3 p-2 rounded-xl hover:bg-gray-100 dark:hover:bg-zinc-700 transition-colors">
                        <i class="fa-solid fa-user-gear w-6 h-6" aria-hidden="true"></i>
                        <span>Admin</span>
                    </a>
                </li>
                <li>
                    <a href="https://livepix.gg/cinerave" target="_blank" class="flex items-center space-x-3 p-2 rounded-xl hover:bg-gray-100 dark:hover:bg-zinc-700 transition-colors">
                        <i class="fa-solid fa-donate w-6 h-6" aria-hidden="true"></i>
                        <span>Doação</span>
                    </a>
                </li>
                <li>
                    <a href="#" id="report-error-link" class="flex items-center space-x-3 p-2 rounded-xl hover:bg-gray-100 dark:hover:bg-zinc-700 transition-colors">
                        <i class="fa-solid fa-bug w-6 h-6" aria-hidden="true"></i>
                        <span>Reportar Erro</span>
                    </a>
                </li>
            </ul>
            <div class="p-4 border-t border-gray-300 dark:border-gray-600 text-xs text-gray-400 dark:text-gray-500">
                <p>UID: <span id="user-uid">Carregando...</span></p>
                <p>Versão 1</p>
            </div>
        </nav>
    </div>

    <!-- Conteúdo Principal - Visão Geral do Catálogo -->
    <main id="main-content" class="p-4">
        <!-- Input de Pesquisa -->
        <div class="relative my-8">
            <input type="text" id="search-input" placeholder="Pesquisar filmes, séries..." class="w-full p-3 pl-10 pr-10 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300 dark:bg-zinc-800 dark:border-gray-700 dark:text-white dark:placeholder-gray-400">
            <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 dark:text-gray-500" aria-hidden="true"></i>
            <button id="clear-search-btn" aria-label="Limpar pesquisa" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 hidden"><i class="fa-solid fa-xmark" aria-hidden="true"></i></button>
            <div id="search-history-container" class="mt-2 hidden">
                <h4 class="text-sm text-gray-500 mb-2">Buscas Recentes:</h4>
                <div id="search-history-list" class="flex flex-wrap gap-2"></div>
            </div>
        </div>

        <!-- Área do Banner de Destaque -->
        <section id="featured-banner" class="mb-8 hidden">
            <!-- Conteúdo dinâmico -->
        </section>
        
        <!-- Carrossel de Sessão Recente -->
        <div id="recent-session-carousel" class="mb-8 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Sessão Recente</h2>
                <button id="clear-recent-session-btn" class="text-sm text-red-500 hover:underline">Limpar</button>
            </div>
            <div class="scrolling-wrapper" id="recent-session-list"></div>
        </div>

        <!-- Nova seção de coleções dinâmicas -->
        <div id="dynamic-collections" class="mb-8">
            <!-- As coleções serão renderizadas aqui dinamicamente -->
        </div>

        <!-- Grade de Lançamentos -->
        <section id="release-grid" class="mb-8">
            <h2 class="text-2xl font-bold mb-4">Lançamentos Recentes</h2>
            <div id="content-grid" class="main-content-grid">
                <!-- Cards de conteúdo dinâmicos -->
            </div>
        </section>
        
        <!-- Placeholder para mensagens de resultados de pesquisa -->
        <div id="results-container" class="mt-8 space-y-4 hidden"></div>
        <div class="flex justify-center mt-8">
            <div id="loading-spinner-home" class="hidden">
                 <i class="fa-solid fa-spinner animate-spin mr-3 h-8 w-8 text-blue-500" aria-hidden="true"></i>
            </div>
            <button id="load-more-home" class="px-6 py-3 bg-black text-white rounded-xl font-semibold hover:bg-gray-800 transition-colors hidden">Ver mais</button>
        </div>
    </main>
    
    <!-- Conteúdo da Página de Detalhes -->
    <div id="details-content" class="hidden">
        <!-- O conteúdo será gerado dinamicamente via JS -->
    </div>

    <!-- Conteúdo da Página de Catálogo -->
    <div id="catalog-content" class="p-4 hidden">
        <h2 class="text-2xl font-bold mb-2 text-center">Catálogo Completo</h2>
        <p class="text-sm text-gray-500 mb-6 text-center text-xl font-semibold"><span id="catalog-count">0</span> conteúdos disponíveis</p>
        <div class="relative my-8">
            <input type="text" id="catalog-search-input" placeholder="Pesquisar no catálogo..." class="w-full p-3 pl-10 pr-10 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300 dark:bg-zinc-800 dark:border-gray-700 dark:text-white dark:placeholder-gray-400">
            <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 dark:text-gray-500" aria-hidden="true"></i>
        </div>
        <div id="catalog-filters" class="flex flex-wrap gap-4 mb-8">
            <!-- Filters will be added here dynamically -->
        </div>
        <div id="full-catalog-grid" class="main-content-grid">
            <!-- Cards de conteúdo dinâmicos -->
        </div>
        <div class="flex justify-center mt-8">
             <div id="loading-spinner-catalog" class="hidden">
                <i class="fa-solid fa-spinner animate-spin mr-3 h-8 w-8 text-blue-500" aria-hidden="true"></i>
            </div>
            <button id="load-more-catalog" class="px-6 py-3 bg-black text-white rounded-xl font-semibold hover:bg-gray-800 transition-colors hidden">Ver mais</button>
        </div>
    </div>
    
    <!-- Conteúdo da Página "Minha Lista" -->
    <div id="my-list-content" class="p-4 hidden">
        <h2 class="text-2xl font-bold mb-2">Minha Lista</h2>
        <div class="flex flex-col sm:flex-row items-center gap-4 mb-4">
            <label for="my-list-sort" class="text-sm">Ordenar por:</label>
            <select id="my-list-sort" class="p-2 rounded-xl border dark:bg-zinc-800 dark:border-gray-700">
                <option value="timestamp">Mais Recente</option>
                <option value="title">Título (A-Z)</option>
            </select>
             <button id="clear-my-list-btn" class="px-4 py-2 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600 transition-colors">
                <i class="fa-solid fa-trash mr-2" aria-hidden="true"></i>Remover Tudo
            </button>
        </div>
        <p id="empty-list-message" class="text-center text-gray-500 mt-8 hidden">Sua lista está vazia. Adicione alguns conteúdos!</p>
        <div id="my-list-grid" class="content-grid">
            <!-- Cards da lista do usuário serão renderizados aqui -->
        </div>
    </div>
    
    <!-- Botão de "Subir para o Topo" -->
    <button id="scroll-to-top-btn" aria-label="Subir para o topo" class="fixed bottom-4 right-4 z-50 bg-blue-500 text-white p-3 rounded-full shadow-lg transition-opacity duration-300 opacity-0 invisible hover:bg-blue-600 focus:outline-none">
        <i class="fa-solid fa-arrow-up" aria-hidden="true"></i>
    </button>

    <!-- Modal de Login do Admin -->
    <div id="admin-login-modal" class="modal fixed inset-0 z-50 bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white dark:bg-zinc-800 p-8 rounded-2xl shadow-xl w-full max-w-sm transform transition-all">
            <h3 class="text-xl font-bold mb-4 text-center text-zinc-900 dark:text-white">Login Admin</h3>
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-4 text-center">Acesso restrito. Insira a senha.</p>
            <input type="password" id="admin-password-input" class="w-full p-3 rounded-xl border border-gray-300 dark:border-gray-700 dark:bg-zinc-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4" placeholder="Senha">
            <p id="admin-login-error" class="text-sm text-red-500 text-center mb-4 hidden">Senha incorreta. Tente novamente.</p>
            <button id="admin-login-button" class="w-full py-3 bg-blue-500 text-white font-bold rounded-xl hover:bg-blue-600 transition-colors">Entrar</button>
            <button id="close-admin-login-modal" class="w-full py-2 mt-2 text-gray-500 dark:text-gray-400">Cancelar</button>
        </div>
    </div>

    <!-- Modal de Confirmação (para deleção de um item da lista) -->
    <div id="my-list-delete-modal" class="modal fixed inset-0 z-50 bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white dark:bg-zinc-800 p-8 rounded-2xl shadow-xl w-full max-w-sm transform transition-all">
            <h3 class="text-xl font-bold mb-4 text-center text-zinc-900 dark:text-white">Confirmar Remoção</h3>
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-4 text-center">Você tem certeza que deseja remover este item da sua lista?</p>
            <div class="flex gap-4 justify-center">
                <button id="confirm-remove-from-list" class="w-full py-3 bg-red-500 text-white font-bold rounded-xl hover:bg-red-600 transition-colors">Remover</button>
                <button id="cancel-remove-from-list" class="w-full py-3 bg-gray-500 text-white font-bold rounded-xl hover:bg-gray-600 transition-colors">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirmação (para deleção de todos os itens da lista) -->
    <div id="clear-my-list-modal" class="modal fixed inset-0 z-50 bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white dark:bg-zinc-800 p-8 rounded-2xl shadow-xl w-full max-w-sm transform transition-all">
            <h3 class="text-xl font-bold mb-4 text-center text-zinc-900 dark:text-white">Confirmar Limpeza</h3>
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-4 text-center">Você tem certeza que deseja remover TODOS os itens da sua lista? Esta ação não pode ser desfeita.</p>
            <div class="flex gap-4 justify-center">
                <button id="confirm-clear-list" class="w-full py-3 bg-red-500 text-white font-bold rounded-xl hover:bg-red-600 transition-colors">Limpar Tudo</button>
                <button id="cancel-clear-list" class="w-full py-3 bg-gray-500 text-white font-bold rounded-xl hover:bg-gray-600 transition-colors">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação (para deleção de admin) -->
    <div id="confirmation-modal" class="modal fixed inset-0 z-50 bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white dark:bg-zinc-800 p-8 rounded-2xl shadow-xl w-full max-w-sm transform transition-all">
            <h3 class="text-xl font-bold mb-4 text-center text-zinc-900 dark:text-white">Confirmar Exclusão</h3>
            <p id="confirmation-message" class="text-sm text-gray-600 dark:text-gray-300 mb-4 text-center">Você tem certeza que deseja excluir este item? Esta ação não pode ser desfeita.</p>
            <div class="flex gap-4 justify-center">
                <button id="confirm-delete-button" class="w-full py-3 bg-red-500 text-white font-bold rounded-xl hover:bg-red-600 transition-colors">Excluir</button>
                <button id="cancel-delete-button" class="w-full py-3 bg-gray-500 text-white font-bold rounded-xl hover:bg-gray-600 transition-colors">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Feedback -->
    <div id="feedback-modal" class="modal fixed inset-0 z-50 bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white dark:bg-zinc-800 p-8 rounded-2xl shadow-xl w-full max-w-lg transform transition-all">
            <h3 class="text-xl font-bold mb-4 text-center text-zinc-900 dark:text-white">Reportar Erro ou Sugestão</h3>
            <div class="space-y-4">
                <p class="font-semibold text-zinc-900 dark:text-white">Tipo de Feedback</p>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="feedback-type" value="Link Quebrado" class="form-radio text-blue-500">
                        <span class="text-gray-700 dark:text-gray-300 text-sm">Link Quebrado</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="feedback-type" value="Filme Errado" class="form-radio text-blue-500">
                        <span class="text-gray-700 dark:text-gray-300 text-sm">Filme Errado</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="feedback-type" value="Sugestão de Conteúdo" class="form-radio text-blue-500">
                        <span class="text-gray-700 dark:text-gray-300 text-sm">Sugestão de Conteúdo</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="feedback-type" value="Outro" class="form-radio text-blue-500">
                        <span class="text-gray-700 dark:text-gray-300 text-sm">Outro</span>
                    </label>
                </div>
                <div>
                    <p class="font-semibold text-zinc-900 dark:text-white">Mensagem</p>
                    <textarea id="feedback-message" rows="4" class="w-full p-2 mt-2 rounded-xl border border-gray-300 dark:border-gray-700 dark:bg-zinc-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Escreva sua mensagem aqui..."></textarea>
                </div>
                <button id="submit-feedback-button" class="w-full py-3 bg-blue-500 text-white font-bold rounded-xl hover:bg-blue-600 transition-colors">Enviar Feedback</button>
            </div>
            <button id="close-feedback-modal" class="w-full py-2 mt-4 text-gray-500 dark:text-gray-400">Fechar</button>
        </div>
    </div>
    
    <!-- Modal genérico para episódios/links -->
    <div id="links-modal" class="modal fixed inset-0 z-50 bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white dark:bg-zinc-800 p-8 rounded-2xl shadow-xl w-full max-w-lg transform transition-all max-h-[80vh] overflow-y-auto">
            <!-- Botão de fechar no topo -->
            <button id="close-links-modal" class="absolute top-4 right-4 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-zinc-700 transition-colors">
                <i class="fa-solid fa-xmark" aria-hidden="true"></i>
            </button>
            <h3 id="links-modal-title" class="text-xl font-bold mb-4 text-center mt-4"></h3>
            <div id="links-modal-content" class="space-y-4"></div>
        </div>
    </div>

    <!-- Modal de Notificações -->
    <div id="notifications-modal" class="modal fixed inset-0 z-50 bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white dark:bg-zinc-800 p-8 rounded-2xl shadow-xl w-full max-w-lg transform transition-all max-h-[80vh] overflow-y-auto">
            <button id="close-notifications-modal" class="absolute top-4 right-4 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-zinc-700 transition-colors">
                <i class="fa-solid fa-xmark" aria-hidden="true"></i>
            </button>
            <h3 class="text-xl font-bold mb-4 text-center text-zinc-900 dark:text-white mt-4">Notificações</h3>
            <div id="notifications-list" class="space-y-4">
                <!-- Conteúdo dinâmico das notificações -->
            </div>
        </div>
    </div>
    
    <!-- Novo Modal de Aviso Legal -->
    <div id="legal-notice-modal" class="modal fixed inset-0 z-50 bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white dark:bg-zinc-800 p-8 rounded-2xl shadow-xl w-full max-w-lg transform transition-all max-h-[80vh] overflow-y-auto">
            <button id="close-legal-notice-modal" class="absolute top-4 right-4 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-zinc-700 transition-colors">
                <i class="fa-solid fa-xmark" aria-hidden="true"></i>
            </button>
            <h3 class="text-xl font-bold mb-4 text-center text-zinc-900 dark:text-white mt-4">Aviso Legal</h3>
            <p class="text-gray-700 dark:text-gray-300">Este aplicativo é apenas uma demonstração. Ele não hospeda nenhum conteúdo de vídeo. Todos os links fornecidos são externos e de responsabilidade do usuário final. O uso deste aplicativo deve estar em conformidade com as leis e regulamentos locais de direitos autorais.</p>
        </div>
    </div>

    <!-- Painel do Administrador (agora uma seção estática, inicialmente oculta) -->
    <div id="admin-panel" class="p-4 hidden">
        <h2 class="text-3xl font-bold my-8 text-center">Painel do Administrador</h2>
        
        <!-- Botões de Navegação do Admin -->
        <div class="flex flex-wrap justify-center gap-4 mb-8">
            <button id="show-content-btn" class="px-4 py-2 bg-blue-500 text-white font-bold rounded-xl hover:bg-blue-600 transition-colors">Gerenciar Conteúdo</button>
            <button id="show-feedback-btn" class="px-4 py-2 bg-gray-500 text-white font-bold rounded-xl hover:bg-gray-600 transition-colors">Ver Feedbacks</button>
            <button id="add-new-btn" class="px-4 py-2 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition-colors">Adicionar Novo</button>
        </div>

        <!-- Seção de Gerenciamento de Conteúdo -->
        <div id="content-management-section" class="space-y-8 p-4 bg-gray-100 dark:bg-zinc-800 rounded-2xl shadow-xl">
            <h3 class="text-xl font-bold mb-4">Gerenciar Conteúdo</h3>
            
            <div id="content-form-section">
                <h4 id="form-title" class="text-lg font-bold mb-4">Adicionar Novo Conteúdo</h4>
                <div class="mb-4">
                    <div class="relative">
                        <input type="text" id="tmdb-search-input" placeholder="Buscar filme/série no TMDB" class="w-full p-2 pl-8 rounded-xl border border-gray-300 dark:border-gray-700 dark:bg-zinc-700 dark:text-white">
                        <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 dark:text-gray-500" aria-hidden="true"></i>
                    </div>
                </div>
                <div id="tmdb-results" class="space-y-2"></div>

                <form id="content-form" class="mt-8 space-y-4">
                    <div>
                        <label class="block mb-1 font-semibold">Título</label>
                        <input type="text" id="content-title" class="w-full p-2 rounded-xl border dark:bg-zinc-700" required>
                    </div>
                    <div>
                        <label class="block mb-1 font-semibold">Sinopse</label>
                        <textarea id="content-synopsis" class="w-full p-2 rounded-xl border dark:bg-zinc-700" rows="4"></textarea>
                    </div>
                    <div>
                        <label class="block mb-1 font-semibold">Ano de Lançamento</label>
                        <input type="text" id="content-year" class="w-full p-2 rounded-xl border dark:bg-zinc-700">
                    </div>
                    <div>
                        <label class="block mb-1 font-semibold">Gêneros</label>
                        <input type="text" id="content-genres" class="w-full p-2 rounded-xl border dark:bg-zinc-700">
                    </div>
                    <div>
                        <label class="block mb-1 font-semibold">Atores Principais</label>
                        <input type="text" id="content-actors" class="w-full p-2 rounded-xl border dark:bg-zinc-700">
                    </div>
                    <!-- Campo para prêmios -->
                    <div>
                        <label class="block mb-1 font-semibold">Prêmio (ex: Oscar de Melhor Filme)</label>
                        <input type="text" id="content-award" class="w-full p-2 rounded-xl border dark:bg-zinc-700">
                    </div>


                    <!-- Seção de Links - Filmes -->
                    <div id="movie-links-container" class="space-y-4">
                        <h4 class="font-bold">Links de Streaming (Filme)</h4>
                        <div class="space-y-2" id="movie-links-list"></div>
                        <button type="button" id="add-movie-link-btn" class="w-full py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-colors">Adicionar Novo Link de Filme</button>
                    </div>

                    <!-- Seção de Links - Séries -->
                    <div id="series-links-container" class="space-y-4 hidden">
                         <button type="button" id="add-season-btn" class="w-full py-2 mb-4 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600 transition-colors">Adicionar Nova Temporada</button>
                        <div class="space-y-4" id="seasons-container"></div>
                    </div>
                    
                    <input type="hidden" id="content-poster-path">
                    <input type="hidden" id="content-backdrop-path">
                    <input type="hidden" id="content-media-type">

                    <button type="submit" id="publish-btn" class="w-full py-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition-colors">Publicar Conteúdo</button>
                </form>
            </div>
            
            <hr class="my-8 border-gray-300 dark:border-gray-700">

            <!-- Conteúdo Existente -->
            <div id="existing-content">
                <h4 class="text-xl font-bold mb-4">Conteúdo Publicado</h4>
                <div class="relative mb-4">
                    <input type="text" id="admin-search-input" placeholder="Buscar conteúdo publicado..." class="w-full p-2 pl-8 rounded-xl border border-gray-300 dark:border-gray-700 dark:bg-zinc-700 dark:text-white">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 dark:text-gray-500" aria-hidden="true"></i>
                </div>
                <ul id="content-list" class="space-y-2"></ul>
            </div>
        </div>

        <!-- Seção de Visualização de Feedbacks -->
        <div id="feedback-section" class="space-y-4 p-4 bg-gray-100 dark:bg-zinc-800 rounded-2xl shadow-xl hidden">
            <h3 class="text-xl font-bold mb-4">Feedbacks Recebidos</h3>
            <ul id="feedback-list" class="space-y-4"></ul>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, collection, query, onSnapshot, deleteDoc, serverTimestamp, getDoc, getDocs, where, orderBy, limit, startAfter, startAt, endAt } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const TMDB_API_KEY = 'd0f7e2c414b1efff7b000ae9b681ed1b';
        const IMAGE_BASE_URL = 'https://image.tmdb.org/t/p/';
        const QUALITIES = ['HD', 'FullHD', '4K', 'SD', 'Outra'];
        const LANGUAGES = ['Dublado', 'Legendado', 'Original', 'Outro'];
        const APP_ID = 'cinerave-v1';

        // Variáveis globais para o estado do aplicativo
        let firebaseApp, auth, db, currentUserId;
        let isAdmin = false;
        let allContent = [];
        let lastVisibleHome = null;
        let lastVisibleCatalog = null;
        let catalogFilters = {};
        let currentFilter = 'home';
        let scrollPositions = { 'home': 0, 'series': 0, 'trending': 0 };
        const PAGE_SIZE = 12;
        let contentToDelete = null;
        let currentContent = null;
        let contentToRemoveFromList = null;

        const firebaseConfig = {
            apiKey: "AIzaSyD6h52BP7wixjudCi3VcLXUAp3xYVNCZMY",
            authDomain: "apprave-bf971.firebaseapp.com",
            projectId: "apprave-bf971",
            storageBucket: "apprave-bf971.firebasestorage.app",
            messagingSenderId: "1096090096842",
            appId: "1:1096090096842:web:4428efcac3b942f9efd033"
        };
        
        // Variável para armazenar o histórico de navegação
        let recentSession = [];
        const RECENT_SESSION_LIMIT = 5;
        const recentSessionKey = 'cinerave_recent_session';
        
        // Variável para controlar se a sessão recente deve ser mostrada
        let showRecentSession = true;
        const showRecentSessionKey = 'cinerave_show_recent_session';
        
        function loadRecentSession() {
            try {
                recentSession = JSON.parse(localStorage.getItem(recentSessionKey)) || [];
                showRecentSession = JSON.parse(localStorage.getItem(showRecentSessionKey)) || true;
            } catch(e) {
                console.error("Erro ao carregar sessão recente:", e);
                recentSession = [];
                showRecentSession = true;
            }
        }
        loadRecentSession();
        
        function saveRecentSession(content) {
            const existingIndex = recentSession.findIndex(item => item.id === content.id);
            if (existingIndex !== -1) {
                recentSession.splice(existingIndex, 1);
            }
            recentSession.unshift(content);
            if (recentSession.length > RECENT_SESSION_LIMIT) {
                recentSession.pop();
            }
            localStorage.setItem(recentSessionKey, JSON.stringify(recentSession));
        }

        function removeRecentSessionItem(contentId) {
            const existingIndex = recentSession.findIndex(item => item.id === contentId);
            if (existingIndex !== -1) {
                recentSession.splice(existingIndex, 1);
                localStorage.setItem(recentSessionKey, JSON.stringify(recentSession));
                renderRecentSession();
            }
        }
        
        function clearRecentSession() {
             recentSession = [];
             localStorage.removeItem(recentSessionKey);
             renderRecentSession();
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Elementos DOM
            const themeToggle = document.getElementById('theme-toggle');
            const html = document.documentElement;
            const menuButton = document.getElementById('menu-button');
            const closeMenuButton = document.getElementById('close-menu-button');
            const sideMenuContainer = document.getElementById('side-menu-container');
            const sideMenu = document.getElementById('side-menu');
            const mainContent = document.getElementById('main-content');
            const detailsContent = document.getElementById('details-content');
            const catalogContent = document.getElementById('catalog-content');
            const myListContent = document.getElementById('my-list-content');
            const userUidSpan = document.getElementById('user-uid');
            const adminLoginLink = document.querySelector('.admin-link');
            const adminLoginModal = document.getElementById('admin-login-modal');
            const adminPasswordInput = document.getElementById('admin-password-input');
            const adminLoginButton = document.getElementById('admin-login-button');
            const adminLoginError = document.getElementById('admin-login-error');
            const closeAdminLoginModal = document.getElementById('close-admin-login-modal');
            const reportErrorLink = document.getElementById('report-error-link');
            const feedbackModal = document.getElementById('feedback-modal');
            const closeFeedbackModal = document.getElementById('close-feedback-modal');
            const submitFeedbackButton = document.getElementById('submit-feedback-button');
            const feedbackMessageInput = document.getElementById('feedback-message');
            const searchInput = document.getElementById('search-input');
            const clearSearchBtn = document.getElementById('clear-search-btn');
            const resultsContainer = document.getElementById('results-container');
            const appTitle = document.getElementById('app-title');
            const featuredBanner = document.getElementById('featured-banner');
            const releaseGridSection = document.getElementById('release-grid');
            const contentGrid = document.getElementById('content-grid');
            const fullCatalogGrid = document.getElementById('full-catalog-grid');
            const catalogCountSpan = document.getElementById('catalog-count');
            const linksModal = document.getElementById('links-modal');
            const linksModalTitle = document.getElementById('links-modal-title');
            const linksModalContent = document.getElementById('links-modal-content');
            const closeLinksModal = document.getElementById('close-links-modal');
            const myListLink = document.getElementById('my-list-link');
            const notificationsBtn = document.getElementById('notifications-btn');
            const notificationsModal = document.getElementById('notifications-modal');
            const closeNotificationsModal = document.getElementById('close-notifications-modal');
            const notificationsList = document.getElementById('notifications-list');
            const notificationBadge = document.getElementById('notification-badge');
            const scrollToTopBtn = document.getElementById('scroll-to-top-btn');
            const catalogSearchInput = document.getElementById('catalog-search-input');
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmDeleteButton = document.getElementById('confirm-delete-button');
            const cancelDeleteButton = document.getElementById('cancel-delete-button');
            const searchHistoryContainer = document.getElementById('search-history-container');
            const searchHistoryList = document.getElementById('search-history-list');
            const loadingSpinnerHome = document.getElementById('loading-spinner-home');
            const loadingSpinnerCatalog = document.getElementById('loading-spinner-catalog');
            const loadMoreHomeBtn = document.getElementById('load-more-home');
            const loadMoreCatalogBtn = document.getElementById('load-more-catalog');
            const catalogFiltersDiv = document.getElementById('catalog-filters');
            const myListSortSelect = document.getElementById('my-list-sort');
            const adminSearchInput = document.getElementById('admin-search-input');
            const publishBtn = document.getElementById('publish-btn');
            const loadingBar = document.getElementById('loading-bar');
            const dynamicCollectionsDiv = document.getElementById('dynamic-collections');
            
            // Nova navegação
            const navHomeBtn = document.getElementById('nav-home');
            const navSeriesBtn = document.getElementById('nav-series');
            const navTrendingBtn = document.getElementById('nav-trending');
            
            // Novos modais e links
            const myListDeleteModal = document.getElementById('my-list-delete-modal');
            const clearMyListModal = document.getElementById('clear-my-list-modal');
            const confirmRemoveFromListBtn = document.getElementById('confirm-remove-from-list');
            const cancelRemoveFromListBtn = document.getElementById('cancel-remove-from-list');
            const clearMyListBtn = document.getElementById('clear-my-list-btn');
            const confirmClearListBtn = document.getElementById('confirm-clear-list');
            const cancelClearListBtn = document.getElementById('cancel-clear-list');
            const surpriseMeLink = document.getElementById('surprise-me-link');
            const legalNoticeLink = document.getElementById('legal-notice-link');
            const legalNoticeModal = document.getElementById('legal-notice-modal');
            const closeLegalNoticeModal = document.getElementById('close-legal-notice-modal');
             const toggleRecentSessionBtn = document.getElementById('toggle-recent-session-btn');
             const toggleRecentSessionText = document.getElementById('toggle-recent-session-text');


            // Inicialização do Firebase
            try {
                firebaseApp = initializeApp(firebaseConfig);
                auth = getAuth(firebaseApp);
                db = getFirestore(firebaseApp);
                console.log("Firebase inicializado com sucesso.");

                // Autenticação anônima
                await signInAnonymously(auth);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userUidSpan.textContent = user.uid;
                        console.log("Usuário autenticado:", currentUserId);
                        // Configura os listeners em tempo real após a autenticação
                        setupRealtimeListeners();
                        loadInitialPage();
                        
                        // Restaura o estado do modal se houver um
                        restoreModalState();
                    } else {
                        userUidSpan.textContent = "Não autenticado";
                        console.log("Usuário não autenticado.");
                    }
                });

            } catch (error) {
                console.error("Erro ao inicializar o Firebase:", error);
                userUidSpan.textContent = "Erro no Firebase";
            }
            
            // Lógica para fechar modais com a tecla Esc
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (adminLoginModal.classList.contains('active')) closeAdminLoginModal.click();
                    if (feedbackModal.classList.contains('active')) closeFeedbackModal.click();
                    if (linksModal.classList.contains('active')) closeLinksModal.click();
                    if (notificationsModal.classList.contains('active')) closeNotificationsModal.click();
                    if (confirmationModal.classList.contains('active')) cancelDeleteButton.click();
                    if (myListDeleteModal.classList.contains('active')) cancelRemoveFromListBtn.click();
                    if (clearMyListModal.classList.contains('active')) cancelClearListBtn.click();
                    if (legalNoticeModal.classList.contains('active')) closeLegalNoticeModal.click();
                }
            });
            // Lógica para confirmar a exclusão com a tecla Enter
            confirmDeleteButton.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    confirmDeleteButton.click();
                }
            });

            // Funções de URL única
            function loadInitialPage() {
                const urlParams = new URLSearchParams(window.location.search);
                const page = urlParams.get('page');
                const id = urlParams.get('id');

                if (page === 'details' && id) {
                    fetchAndRenderDetailsPage(id);
                } else if (page === 'catalog') {
                    renderCatalogPage();
                } else if (page === 'my-list') {
                    renderMyListPage();
                } else {
                    loadHomePage();
                }
            }
            
            // --- Funções de Navegação e Carregamento de Páginas ---
            function showPage(pageId) {
                const pages = [mainContent, detailsContent, catalogContent, myListContent, document.getElementById('admin-panel')];
                pages.forEach(page => { if (page) page.classList.add('hidden') });
                searchInput.classList.remove('hidden');
                resultsContainer.classList.add('hidden');
                featuredBanner.classList.add('hidden');
                releaseGridSection.classList.add('hidden');

                if (pageId === 'main-content') {
                    mainContent.classList.remove('hidden');
                } else if (pageId === 'details-content') {
                    detailsContent.classList.remove('hidden');
                    searchInput.classList.add('hidden');
                } else if (pageId === 'catalog-content') {
                    catalogContent.classList.remove('hidden');
                    searchInput.classList.add('hidden');
                } else if (pageId === 'my-list-content') {
                    myListContent.classList.remove('hidden');
                    searchInput.classList.add('hidden');
                } else if (pageId === 'admin-panel') {
                    const adminPanel = document.getElementById('admin-panel');
                    if (adminPanel) adminPanel.classList.remove('hidden');
                    searchInput.classList.add('hidden');
                }
            }

            function updateHistory(page, id = null) {
                if (window.location.protocol === 'blob:') {
                    return; // Evita o erro em blob URLs
                }
                let url = window.location.pathname;
                if (page === 'details' && id) {
                    url += `?page=details&id=${id}`;
                } else if (page === 'catalog') {
                    url += `?page=catalog`;
                } else if (page === 'my-list') {
                    url += `?page=my-list`;
                }
                window.history.pushState({}, '', url);
            }
            
            async function loadHomePage() {
                searchInput.value = '';
                resultsContainer.innerHTML = '';
                resultsContainer.classList.add('hidden');
                showPage('main-content');
                updateHistory('home');
                renderSearchHistory();
                renderRecentSession();
                contentGrid.innerHTML = renderSkeletonLoaders(PAGE_SIZE);
                featuredBanner.classList.add('hidden');
                releaseGridSection.classList.remove('hidden');
                lastVisibleHome = null;
                await renderDynamicCollections(allContent);
                await loadMainContent(null, allContent);
                updateNavActiveState('nav-home');
                window.scrollTo(0, scrollPositions['home']);
            }
            
            // --- Função de renderização de coleções dinâmicas ---
            function renderDynamicCollections(contentArray) {
                if (!contentArray || contentArray.length === 0) {
                    dynamicCollectionsDiv.innerHTML = '';
                    return;
                }
                
                dynamicCollectionsDiv.innerHTML = '';
                
                // Coleção: Adicionados Recentemente (baseado no timestamp)
                const recentContent = [...contentArray].sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)).slice(0, 10);
                if (recentContent.length > 0) {
                    renderCollection('Adicionados Recentemente', recentContent);
                }

                // Coleção: Comédias que você vai amar (exemplo de filtro por gênero)
                const comedyContent = contentArray.filter(c => c.genres.includes('Comédia')).slice(0, 10);
                if (comedyContent.length > 0) {
                    renderCollection('Comédias que você vai amar', comedyContent);
                }
                
                // Coleção: Terror (novo carrossel)
                const horrorContent = contentArray.filter(c => c.genres.includes('Terror')).slice(0, 10);
                if (horrorContent.length > 0) {
                    renderCollection('Filmes de Terror', horrorContent);
                }

                 // Coleção: Kids (novo carrossel)
                const kidsContent = contentArray.filter(c => c.genres.includes('Infantil')).slice(0, 10);
                if (kidsContent.length > 0) {
                    renderCollection('Para as Crianças', kidsContent);
                }

                // Coleção: Em Alta (uma seleção aleatória para simular popularidade)
                const shuffledContent = [...contentArray].sort(() => 0.5 - Math.random()).slice(0, 10);
                if (shuffledContent.length > 0) {
                     renderCollection('Em Alta', shuffledContent);
                }
            }

            function renderCollection(title, contentArray) {
                const collectionSection = document.createElement('section');
                collectionSection.className = 'mb-8';
                collectionSection.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4">${title}</h2>
                    <div class="scrolling-wrapper">
                        ${contentArray.map(content => renderContentCard(content, null, true)).join('')}
                    </div>
                `;
                dynamicCollectionsDiv.appendChild(collectionSection);
            }
            // --- Fim da nova funcionalidade de coleções dinâmicas ---

            function renderRecentSession() {
                const recentSessionContainer = document.getElementById('recent-session-carousel');
                const recentSessionList = document.getElementById('recent-session-list');
                const toggleRecentSessionText = document.getElementById('toggle-recent-session-text');
                
                if (!showRecentSession) {
                     recentSessionContainer.classList.add('hidden');
                     toggleRecentSessionText.textContent = "Mostrar Sessão Recente";
                     return;
                }
                
                if (recentSession.length > 0) {
                    recentSessionContainer.classList.remove('hidden');
                    recentSessionList.innerHTML = '';
                    recentSession.forEach(content => {
                        const posterUrl = content.poster_path ? `${IMAGE_BASE_URL}w500${content.poster_path}` : 'https://placehold.co/500x750/cccccc/333333?text=Sem+Pôster';
                        const card = document.createElement('div');
                        card.className = 'content-card relative group cursor-pointer overflow-hidden rounded-2xl shadow-lg hover:shadow-2xl transition-shadow duration-300';
                        card.dataset.id = content.id;
                        card.innerHTML = `
                             <img src="${posterUrl}" alt="Pôster de ${content.title}" class="w-full h-auto object-cover rounded-2xl group-hover:scale-105 transition-transform duration-300">
                             <div class="content-card-overlay absolute inset-0 bg-black bg-opacity-70 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col items-center justify-center p-2 text-center">
                                 <h4 class="text-white font-bold text-sm sm:text-base">${content.title}</h4>
                             </div>
                             <button class="absolute top-2 right-2 p-1 text-white bg-red-600 rounded-full hover:bg-red-700 remove-recent-btn" data-id="${content.id}">
                                <i class="fa-solid fa-times"></i>
                             </button>
                        `;
                        recentSessionList.appendChild(card);
                    });
                     toggleRecentSessionText.textContent = "Ocultar Sessão Recente";
                } else {
                    recentSessionContainer.classList.add('hidden');
                    toggleRecentSessionText.textContent = "Mostrar Sessão Recente";
                }
            }

            document.getElementById('clear-recent-session-btn').addEventListener('click', clearRecentSession);

            toggleRecentSessionBtn.addEventListener('click', () => {
                 showRecentSession = !showRecentSession;
                 localStorage.setItem(showRecentSessionKey, JSON.stringify(showRecentSession));
                 renderRecentSession();
            });


            async function renderCatalogPage() {
                showPage('catalog-content');
                updateHistory('catalog');
                fullCatalogGrid.innerHTML = renderSkeletonLoaders(PAGE_SIZE);
                lastVisibleCatalog = null;
                catalogFilters = {};
                renderCatalogFilters();
                await loadFullCatalog();
            }
            
            async function renderMyListPage() {
                showPage('my-list-content');
                updateHistory('my-list');
                const myListGrid = document.getElementById('my-list-grid');
                myListGrid.innerHTML = '';
                const emptyMessage = document.getElementById('empty-list-message');
                emptyMessage.classList.add('hidden');

                const sortBy = myListSortSelect.value;
                
                if (auth.currentUser) {
                    const myListRef = collection(db, `artifacts/${APP_ID}/users/${auth.currentUser.uid}/my_list`);
                    let myListQuery = query(myListRef, orderBy(sortBy, sortBy === 'title' ? 'asc' : 'desc'));
                    const querySnapshot = await getDocs(myListQuery);
                    if (querySnapshot.empty) {
                        emptyMessage.classList.remove('hidden');
                    } else {
                        querySnapshot.forEach(doc => {
                            renderMyListCard({ id: doc.id, ...doc.data() }, myListGrid);
                        });
                    }
                } else {
                    emptyMessage.textContent = "Faça login para ver sua lista.";
                    emptyMessage.classList.remove('hidden');
                }
            }

            async function loadMainContent(lastDoc = null, contentToRender = null) {
                if (lastDoc === 'end') return;
                loadingSpinnerHome.classList.remove('hidden');
                
                let q = query(collection(db, `artifacts/${APP_ID}/public/data/content`), orderBy('timestamp', 'desc'), limit(PAGE_SIZE));
                if (lastDoc) {
                    q = query(collection(db, `artifacts/${APP_ID}/public/data/content`), orderBy('timestamp', 'desc'), startAfter(lastDoc), limit(PAGE_SIZE));
                }

                try {
                    const querySnapshot = await getDocs(q);
                    if (!lastDoc) {
                        contentGrid.innerHTML = '';
                        const allContentList = contentToRender || querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                        if(allContentList.length > 0) {
                            renderFeaturedBanner(allContentList[0]);
                        }
                    }
                    querySnapshot.docs.forEach(doc => renderContentCard({ id: doc.id, ...doc.data() }, contentGrid));
                    lastVisibleHome = querySnapshot.docs[querySnapshot.docs.length - 1] || 'end';
                    if (lastVisibleHome === 'end' || querySnapshot.empty || querySnapshot.docs.length < PAGE_SIZE) {
                        loadMoreHomeBtn.classList.add('hidden');
                    } else {
                        loadMoreHomeBtn.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Erro ao carregar conteúdo:", error);
                } finally {
                    loadingSpinnerHome.classList.add('hidden');
                }
            }
            
            async function filterAndRenderContent(filterType) {
                scrollPositions[currentFilter] = window.scrollY; // Salva a posição anterior
                currentFilter = filterType;
                
                contentGrid.innerHTML = renderSkeletonLoaders(PAGE_SIZE);
                featuredBanner.classList.add('hidden');
                dynamicCollectionsDiv.innerHTML = '';
                
                let filteredContent = [];
                if (filterType === 'home') {
                    loadMainContent();
                    renderDynamicCollections(allContent);
                } else if (filterType === 'series') {
                    filteredContent = allContent.filter(c => c.media_type === 'tv');
                    renderContentList(filteredContent);
                    renderSeasonHighlights(filteredContent);
                } else if (filterType === 'trending') {
                     // Simulação de conteúdo "Em Alta" usando uma ordenação diferente ou aleatória
                    filteredContent = [...allContent].sort(() => 0.5 - Math.random());
                    renderContentList(filteredContent);
                }
                 updateNavActiveState(`nav-${filterType}`);
                 window.scrollTo(0, scrollPositions[currentFilter]);
            }
            
            function renderContentList(contentArray) {
                contentGrid.innerHTML = '';
                contentArray.forEach(content => renderContentCard(content, contentGrid));
                if (contentArray.length > 0) {
                    renderFeaturedBanner(contentArray[0]);
                }
            }
            
            function updateNavActiveState(activeId) {
                const navButtons = [navHomeBtn, navSeriesBtn, navTrendingBtn];
                navButtons.forEach(btn => {
                    btn.classList.remove('text-zinc-900', 'dark:text-white', 'border-b-2', 'border-black', 'dark:border-white');
                    btn.classList.add('text-gray-500', 'dark:text-gray-400');

                    if (btn.id === activeId) {
                        btn.classList.add('text-zinc-900', 'dark:text-white', 'border-b-2', 'border-black', 'dark:border-white');
                        btn.classList.remove('text-gray-500', 'dark:text-gray-400');
                    }
                });
            }

            async function loadFullCatalog(lastDoc = null, filters = {}) {
                if (lastDoc === 'end') return;
                loadingSpinnerCatalog.classList.remove('hidden');
                const fetchSize = PAGE_SIZE;
                let q = query(collection(db, `artifacts/${APP_ID}/public/data/content`), orderBy('timestamp', 'desc'), limit(fetchSize));
                if (lastDoc) {
                    q = query(collection(db, `artifacts/${APP_ID}/public/data/content`), orderBy('timestamp', 'desc'), startAfter(lastDoc), limit(fetchSize));
                }

                try {
                    const querySnapshot = await getDocs(q);
                    const fetchedContent = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    if (!lastDoc) fullCatalogGrid.innerHTML = '';

                    const genreFilter = document.getElementById('genre-filter')?.value;
                    const languageFilter = document.getElementById('language-filter')?.value;
                    const qualityFilter = document.getElementById('quality-filter')?.value;

                    let filteredContent = fetchedContent.filter(content => {
                        let matches = true;
                        if (genreFilter && content.genres && !content.genres.includes(genreFilter)) {
                            matches = false;
                        }
                        if (languageFilter && content.links && !content.links.some(link => link.language === languageFilter)) {
                            matches = false;
                        }
                        if (qualityFilter && content.links && !content.links.some(link => link.quality === qualityFilter)) {
                            matches = false;
                        }
                        return matches;
                    });
                    
                    filteredContent.forEach(content => renderContentCard(content, fullCatalogGrid));
                    
                    lastVisibleCatalog = querySnapshot.docs[querySnapshot.docs.length - 1] || 'end';
                    
                    if (lastVisibleCatalog === 'end' || querySnapshot.empty || querySnapshot.docs.length < PAGE_SIZE) {
                        loadMoreCatalogBtn.classList.add('hidden');
                    } else {
                        loadMoreCatalogBtn.classList.remove('hidden');
                    }

                } catch (error) {
                    console.error("Erro ao carregar catálogo completo:", error);
                } finally {
                     loadingSpinnerCatalog.classList.add('hidden');
                }
            }
            
            function renderSeasonHighlights(contentArray) {
                const seasonHighlights = contentArray.filter(c => c.media_type === 'tv' && c.links && c.links.length > 1);
                const highlightSection = document.getElementById('season-highlights');

                if (seasonHighlights.length === 0) {
                    if (highlightSection) highlightSection.remove();
                    return;
                }
                
                if (!highlightSection) {
                    const newHighlightSection = document.createElement('section');
                    newHighlightSection.id = 'season-highlights';
                    newHighlightSection.className = 'mb-8';
                    dynamicCollectionsDiv.prepend(newHighlightSection);
                }
                
                const scrollingWrapper = document.createElement('div');
                scrollingWrapper.className = 'scrolling-wrapper';
                
                scrollingWrapper.innerHTML = seasonHighlights.map(content => renderContentCard(content, null, true)).join('');
                
                document.getElementById('season-highlights').innerHTML = `
                    <h2 class="text-2xl font-bold mb-4">Destaques de Temporadas</h2>
                `;
                document.getElementById('season-highlights').appendChild(scrollingWrapper);
            }

            function setupRealtimeListeners() {
                // Listener em tempo real para os feedbacks
                onSnapshot(collection(db, `artifacts/${APP_ID}/public/data/feedbacks`), (snapshot) => {
                    const feedbackList = document.getElementById('feedback-list');
                    if (!feedbackList) return;
                    feedbackList.innerHTML = '';
                    snapshot.forEach((doc) => {
                        const feedback = doc.data();
                        const date = feedback.timestamp?.toDate().toLocaleString() || 'N/A';
                        const li = document.createElement('li');
                        li.className = 'p-4 bg-gray-200 dark:bg-zinc-700 rounded-xl';
                        li.innerHTML = `
                            <p class="font-bold">Tipo: ${feedback.type}</p>
                            <p class="text-sm text-gray-700 dark:text-gray-300">Mensagem: ${feedback.message}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Enviado em: ${date}</p>
                            <button data-id="${doc.id}" class="delete-feedback-btn mt-2 py-1 px-2 bg-red-500 text-white rounded-xl text-sm hover:bg-red-600">Excluir</button>
                        `;
                        feedbackList.appendChild(li);
                    });
                });

                // Listener em tempo real para o conteúdo
                onSnapshot(collection(db, `artifacts/${APP_ID}/public/data/content`), (snapshot) => {
                    const contentList = document.getElementById('content-list');
                    if (!contentList) return;

                    // Update local content array
                    allContent = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (catalogCountSpan) catalogCountSpan.textContent = allContent.length;

                    // Update admin list
                    contentList.innerHTML = '';
                    allContent.forEach(content => {
                        const li = document.createElement('li');
                        li.className = 'flex flex-col sm:flex-row items-start sm:items-center justify-between p-2 bg-gray-200 dark:bg-zinc-700 rounded-xl';
                        li.dataset.id = content.id;
                        li.innerHTML = `
                            <div class="flex-1">
                                <span class="font-bold">${content.title} (${content.year})</span>
                                <p class="text-xs text-gray-500 dark:text-gray-400">ID: ${content.id}</p>
                            </div>
                            <div class="mt-2 sm:mt-0 flex space-x-2">
                                <button data-id="${content.id}" class="edit-btn px-2 py-1 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-colors">Editar</button>
                                <button data-id="${content.id}" class="delete-btn px-2 py-1 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-colors">Excluir</button>
                            </div>
                        `;
                        contentList.appendChild(li);
                    });
                    
                    // Re-render the public views if they are active
                    // Use a new list of content to re-render to avoid duplicates
                    if (mainContent.classList.contains('hidden') === false) {
                        // Resets the main content view to display fresh data based on the current filter
                        if (currentFilter === 'series') {
                            const filteredSeries = allContent.filter(c => c.media_type === 'tv');
                            renderContentList(filteredSeries);
                        } else if (currentFilter === 'trending') {
                             const trendingContent = [...allContent].sort(() => 0.5 - Math.random());
                             renderContentList(trendingContent);
                        } else {
                            contentGrid.innerHTML = '';
                            allContent.slice(0, PAGE_SIZE).forEach(content => renderContentCard(content, contentGrid));
                            if(allContent.length > 0) renderFeaturedBanner(allContent[0]);
                            renderDynamicCollections(allContent);
                            renderRecentSession();
                        }
                    }
                    if (catalogContent.classList.contains('hidden') === false) {
                        fullCatalogGrid.innerHTML = '';
                        allContent.forEach(content => renderContentCard(content, fullCatalogGrid));
                    }
                });

                // Listener para notificações em tempo real
                onSnapshot(collection(db, `artifacts/${APP_ID}/public/data/notifications`), (snapshot) => {
                    // Ordena as notificações por timestamp em ordem decrescente
                    const notifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                                                     .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                    
                    const count = notifications.length;
                    notificationBadge.textContent = count;
                    if (count > 0) {
                        notificationBadge.classList.remove('hidden');
                    } else {
                        notificationBadge.classList.add('hidden');
                    }
                    renderNotifications(notifications);
                });
            }

            async function fetchAndRenderDetailsPage(contentId) {
                 scrollPositions[currentFilter] = window.scrollY; // Salva a posição de rolagem atual
                try {
                    const docRef = doc(db, `artifacts/${APP_ID}/public/data/content`, contentId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const content = { id: docSnap.id, ...docSnap.data() };
                        currentContent = content; // Armazena o conteúdo atual para uso nos botões
                        renderDetailsPage(content);
                        showPage('details-content');
                        updateHistory('details', contentId);
                        saveRecentSession(content); // Salva o item na sessão recente
                        renderRecentSession();
                    } else {
                        console.error("Conteúdo não encontrado.");
                        loadHomePage();
                    }
                } catch (error) {
                    console.error("Erro ao buscar conteúdo para a página de detalhes:", error);
                    loadHomePage();
                }
            }
            
            // --- Renderização de UI ---
            function renderFeaturedBanner(content) {
                featuredBanner.classList.remove('hidden');
                const backdropUrl = content.backdrop_path ? `${IMAGE_BASE_URL}w1280${content.backdrop_path}` : 'https://placehold.co/1280x720/1a1a1a/cccccc?text=Sem+Banner';
                featuredBanner.innerHTML = `
                    <div class="relative w-full h-64 sm:h-96 rounded-2xl overflow-hidden shadow-xl">
                        <img src="${backdropUrl}" alt="Banner de ${content.title}" class="absolute inset-0 w-full h-full object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-zinc-900 to-transparent flex items-end p-4 sm:p-8">
                            <div>
                                <h3 class="text-xl sm:text-3xl font-bold text-white mb-2">${content.title}</h3>
                                <p class="text-sm sm:text-base text-gray-300 line-clamp-3">${content.synopsis}</p>
                                <button data-id="${content.id}" class="watch-now-btn mt-4 px-4 py-2 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 transition-colors">
                                    <i class="fa-solid fa-play mr-2" aria-hidden="true"></i>Assistir Agora
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            function renderContentCard(content, container, isCollectionCard = false) {
                const posterUrl = content.poster_path ? `${IMAGE_BASE_URL}w500${content.poster_path}` : 'https://placehold.co/500x750/cccccc/333333?text=Sem+Pôster';
                
                let adminButtons = '';
                if (isAdmin) {
                    adminButtons = `
                        <div class="absolute top-2 right-2 flex space-x-2 z-10">
                            <button data-id="${content.id}" aria-label="Editar conteúdo" class="edit-btn p-1 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors">
                                <i class="fa-solid fa-pencil" aria-hidden="true"></i>
                            </button>
                            <button data-id="${content.id}" aria-label="Excluir conteúdo" class="delete-btn p-1 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors">
                                <i class="fa-solid fa-trash-can" aria-hidden="true"></i>
                            </button>
                        </div>
                    `;
                }

                let seasonBadge = '';
                if (content.media_type === 'tv' && content.links && content.links.length > 0) {
                    const seasonCount = content.links.length;
                    seasonBadge = `
                        <div class="absolute top-2 right-2 bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded-full z-10">
                            ${seasonCount} Temp.
                        </div>
                    `;
                }
                
                // Selo de "Novo!" para séries com novo episódio
                let newEpisodeBadge = '';
                if (content.media_type === 'tv' && content.links && content.links.length > 0) {
                    const latestSeason = content.links.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0))[0];
                    if (latestSeason?.episodes?.length > 0) {
                        const latestEpisodeTimestamp = latestSeason.episodes.sort((a, b) => b.timestamp?.seconds - a.timestamp?.seconds)[0]?.timestamp?.seconds;
                        const now = Math.floor(Date.now() / 1000);
                        const sevenDaysInSeconds = 7 * 24 * 60 * 60;
                        if(latestEpisodeTimestamp && (now - latestEpisodeTimestamp) < sevenDaysInSeconds) {
                            newEpisodeBadge = `
                                <div class="absolute top-2 left-2 bg-green-600 text-white text-xs font-bold px-2 py-1 rounded-full z-10">
                                    Novo!
                                </div>
                            `;
                        }
                    }
                }
                
                const cardHtml = `
                    <img src="${posterUrl}" alt="Pôster de ${content.title}" class="w-full h-auto object-cover rounded-2xl">
                    <div class="content-card-overlay absolute inset-0 bg-black bg-opacity-70 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col items-center justify-center p-2 text-center">
                        <i class="fa-solid fa-play text-white text-4xl mb-2" aria-hidden="true"></i>
                        <h4 class="text-white font-bold text-sm sm:text-base">${content.title}</h4>
                        <p class="text-xs text-gray-300 mt-1">Assistir</p>
                    </div>
                    ${adminButtons}
                    ${seasonBadge}
                    ${newEpisodeBadge}
                `;

                if (isCollectionCard) {
                    return `
                        <div class="content-card relative group cursor-pointer overflow-hidden rounded-2xl shadow-lg hover:shadow-2xl transition-shadow duration-300" data-id="${content.id}">
                            ${cardHtml}
                        </div>
                    `;
                } else {
                    const card = document.createElement('div');
                    card.className = 'content-card relative group cursor-pointer overflow-hidden rounded-2xl shadow-lg hover:shadow-2xl transition-shadow duration-300';
                    card.dataset.id = content.id;
                    card.innerHTML = cardHtml;
                    card.addEventListener('click', (e) => {
                        // Evita o clique em um dos botões de admin
                        if (!e.target.closest('.edit-btn') && !e.target.closest('.delete-btn') && !e.target.closest('.remove-recent-btn')) {
                            fetchAndRenderDetailsPage(content.id);
                        }
                    });
                    container.appendChild(card);
                }
            }

            function renderSkeletonLoaders(count) {
                let html = '';
                for (let i = 0; i < count; i++) {
                    html += `
                        <div class="content-card relative group overflow-hidden rounded-2xl shadow-lg">
                            <div class="w-full h-auto aspect-[2/3] bg-gray-300 dark:bg-zinc-700 rounded-2xl skeleton"></div>
                        </div>
                    `;
                }
                return html;
            }
            

            function renderCatalogFilters() {
                catalogFiltersDiv.innerHTML = `
                    <div>
                        <label for="genre-filter" class="text-sm text-gray-500 dark:text-gray-400">Gênero:</label>
                        <select id="genre-filter" class="p-2 rounded-xl border dark:bg-zinc-800 dark:border-gray-700 w-full md:w-auto">
                            <option value="">Todos</option>
                            <option value="Ação">Ação</option>
                            <option value="Aventura">Aventura</option>
                            <option value="Comédia">Comédia</option>
                            <option value="Ficção Científica">Ficção Científica</option>
                            <option value="Fantasia">Fantasia</option>
                            <option value="Terror">Terror</option>
                            <option value="Drama">Drama</option>
                            <option value="Romance">Romance</option>
                        </select>
                    </div>
                    <div>
                        <label for="language-filter" class="text-sm text-gray-500 dark:text-gray-400">Idioma:</label>
                        <select id="language-filter" class="p-2 rounded-xl border dark:bg-zinc-800 dark:border-gray-700 w-full md:w-auto">
                            <option value="">Todos</option>
                            ${LANGUAGES.map(lang => `<option value="${lang}">${lang}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="quality-filter" class="text-sm text-gray-500 dark:text-gray-400">Qualidade:</label>
                        <select id="quality-filter" class="p-2 rounded-xl border dark:bg-zinc-800 dark:border-gray-700 w-full md:w-auto">
                            <option value="">Todas</option>
                            ${QUALITIES.map(q => `<option value="${q}">${q}</option>`).join('')}
                        </select>
                    </div>
                `;
                document.getElementById('genre-filter').addEventListener('change', () => loadFullCatalog(null, {
                    genres: document.getElementById('genre-filter').value,
                    language: document.getElementById('language-filter').value,
                    quality: document.getElementById('quality-filter').value
                }, true));
                document.getElementById('language-filter').addEventListener('change', () => loadFullCatalog(null, {
                    genres: document.getElementById('genre-filter').value,
                    language: document.getElementById('language-filter').value,
                    quality: document.getElementById('quality-filter').value
                }, true));
                document.getElementById('quality-filter').addEventListener('change', () => loadFullCatalog(null, {
                    genres: document.getElementById('genre-filter').value,
                    language: document.getElementById('language-filter').value,
                    quality: document.getElementById('quality-filter').value
                }, true));
            }


            async function renderDetailsPage(content) {
                const backdropUrl = content.backdrop_path ? `${IMAGE_BASE_URL}w1280${content.backdrop_path}` : 'https://placehold.co/1280x720/1a1a1a/cccccc?text=Sem+Banner';
                const posterUrl = content.poster_path ? `${IMAGE_BASE_URL}w500${content.poster_path}` : 'https://placehold.co/500x750/cccccc/333333?text=Sem+Pôster';
                const userListRef = auth.currentUser ? doc(db, `artifacts/${APP_ID}/users/${auth.currentUser.uid}/my_list`, content.id) : null;
                const docSnap = userListRef ? await getDoc(userListRef) : { exists: () => false };
                const isFavorite = docSnap.exists();
                
                const awardHTML = content.award ? `<span class="bg-yellow-500 text-white text-sm font-bold px-3 py-1 rounded-full"><i class="fa-solid fa-trophy mr-2"></i>${content.award}</span>` : '';
                
                detailsContent.innerHTML = `
                    <div class="relative w-full h-64 sm:h-96 rounded-2xl overflow-hidden shadow-lg mb-8 z-10">
                        <img src="${backdropUrl}" alt="Banner de fundo de ${content.title}" class="absolute inset-0 w-full h-full object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-zinc-900 via-zinc-900/50 to-transparent"></div>
                    </div>
                    <div class="p-4 -mt-32 sm:-mt-48 md:-mt-56 relative z-20">
                        <div class="flex flex-col md:flex-row items-center md:items-start">
                            <img src="${posterUrl}" alt="Pôster de ${content.title}" class="w-48 h-auto max-w-[200px] rounded-2xl shadow-xl mb-4 md:mb-0 transform transition-transform duration-300 hover:scale-105">
                            <div class="md:ml-8 flex-1 mt-4 md:mt-0">
                                <h1 class="text-3xl sm:text-4xl font-bold mb-2 flex flex-col sm:flex-row items-center sm:items-baseline">
                                    ${content.title}
                                    <span class="text-lg text-gray-400 ml-2">(${content.year})</span>
                                    <button id="copy-link-btn" class="ml-2 text-blue-400 hover:text-blue-600 transition-colors text-base" aria-label="Copiar link para ${content.title}">
                                        <i class="fa-solid fa-copy" aria-hidden="true"></i>
                                    </button>
                                </h1>
                                <p class="text-sm text-gray-400 mb-4 flex items-center space-x-2">
                                     <span>${(content.genres || []).join(', ')}</span>
                                     ${awardHTML}
                                </p>
                                <p id="synopsis" class="text-base text-gray-700 mb-4 dark:text-zinc-300"></p>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4"><strong>Atores:</strong> ${(content.actors || []).join(', ')}</p>
                                
                                <div class="flex flex-wrap items-center justify-center md:justify-start gap-4 mt-6">
                                    <button id="watch-btn" class="px-4 py-2 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 transition-colors">
                                        <i class="fa-solid fa-play mr-2" aria-hidden="true"></i>Assistir Agora
                                    </button>
                                    <button id="add-to-list-btn" class="px-4 py-2 text-white rounded-xl font-semibold transition-colors ${isFavorite ? 'bg-red-600 hover:bg-red-700' : 'bg-gray-600 hover:bg-gray-700'}">
                                        <i class="fa-solid fa-heart mr-2" aria-hidden="true"></i>${isFavorite ? 'Remover da Lista' : 'Minha Lista'}
                                    </button>
                                    <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(content.title)}+trailer" target="_blank" class="px-4 py-2 bg-red-600 text-white rounded-xl font-semibold hover:bg-red-700 transition-colors">
                                        <i class="fa-brands fa-youtube mr-2" aria-hidden="true"></i>Ver Trailer
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const synopsisElement = document.getElementById('synopsis');
                synopsisElement.textContent = content.synopsis;
                
                const showMoreBtnHtml = `<button id="toggle-synopsis" class="text-black text-sm hover:underline mt-2 block dark:text-white">Ver mais</button>`;
                if (synopsisElement.scrollHeight > synopsisElement.clientHeight) {
                    synopsisElement.classList.add('line-clamp-4');
                    synopsisElement.insertAdjacentHTML('afterend', showMoreBtnHtml);
                } else if (synopsisElement.scrollHeight > 80 && synopsisElement.clientHeight < synopsisElement.scrollHeight) {
                    // This handles cases where initial render might not be clamped
                    synopsisElement.classList.add('line-clamp-4');
                    synopsisElement.insertAdjacentHTML('afterend', showMoreBtnHtml);
                }
                
                const toggleSynopsisBtn = document.getElementById('toggle-synopsis');
                if (toggleSynopsisBtn) {
                     toggleSynopsisBtn.addEventListener('click', (e) => {
                         synopsisElement.classList.toggle('line-clamp-4');
                         e.target.textContent = synopsisElement.classList.contains('line-clamp-4') ? 'Ver mais' : 'Ver menos';
                     });
                }
                
                document.getElementById('watch-btn').addEventListener('click', () => {
                    if (content.links && content.links.length > 0) {
                        if (content.media_type === 'movie') {
                             if(content.links[0]?.url) {
                                window.open(content.links[0].url, '_blank');
                            }
                        } else if (content.media_type === 'tv') {
                            renderSeasonsModal(content);
                        }
                    } else {
                        showTempMessage("Nenhum link de streaming disponível para este conteúdo.", false);
                    }
                });

                document.getElementById('add-to-list-btn').addEventListener('click', async (e) => {
                    const button = e.target.closest('button');
                    if (!auth.currentUser) {
                        showTempMessage("Você precisa estar autenticado para adicionar à sua lista.", false);
                        return;
                    }
                    if (button.textContent.includes('Remover')) {
                        await removeFromMyList(content.id);
                        button.innerHTML = '<i class="fa-solid fa-heart mr-2" aria-hidden="true"></i>Minha Lista';
                        button.classList.remove('bg-red-600', 'hover:bg-red-700');
                        button.classList.add('bg-gray-600', 'hover:bg-gray-700');
                    } else {
                        await addToMyList(content);
                        button.innerHTML = '<i class="fa-solid fa-heart mr-2" aria-hidden="true"></i>Remover da Lista';
                        button.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                        button.classList.add('bg-red-600', 'hover:bg-red-700');
                    }
                });

                document.getElementById('copy-link-btn').addEventListener('click', () => {
                    const url = window.location.origin + `?page=details&id=${content.id}`;
                    document.execCommand('copy');
                    showTempMessage('Link copiado para a área de transferência!');
                });
            }

            function renderMyListCard(content, container) {
                const posterUrl = content.poster_path ? `${IMAGE_BASE_URL}w500${content.poster_path}` : 'https://placehold.co/500x750/cccccc/333333?text=Sem+Pôster';
                const card = document.createElement('div');
                card.className = 'relative group overflow-hidden rounded-2xl shadow-lg hover:shadow-2xl transition-shadow duration-300';
                card.dataset.id = content.id;
                card.innerHTML = `
                    <img src="${posterUrl}" alt="Pôster de ${content.title}" class="w-full h-auto object-cover rounded-2xl group-hover:scale-105 transition-transform duration-300">
                    <div class="absolute inset-0 bg-black bg-opacity-70 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col items-center justify-center p-2 text-center">
                        <div>
                            <h4 class="text-white font-bold text-sm sm:text-base">${content.title}</h4>
                        </div>
                        <button data-id="${content.id}" class="remove-from-list-btn mt-2 px-4 py-2 bg-red-600 text-white rounded-xl font-semibold hover:bg-red-700 transition-colors">
                            <i class="fa-solid fa-trash mr-2" aria-hidden="true"></i>Remover
                        </button>
                    </div>
                `;
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.remove-from-list-btn')) {
                        fetchAndRenderDetailsPage(content.id);
                    }
                });
                container.appendChild(card);
            }

            // Funções de salvamento e recuperação do estado do modal
            function saveModalState(modalType, contentId, data) {
                try {
                    localStorage.setItem('modalState', JSON.stringify({ modalType, contentId, data }));
                } catch (e) {
                    console.error("Não foi possível salvar o estado do modal.", e);
                }
            }

            function restoreModalState() {
                try {
                    const state = JSON.parse(localStorage.getItem('modalState'));
                    if (state) {
                        localStorage.removeItem('modalState');
                        if (state.modalType === 'seasons') {
                            fetchAndRenderDetailsPage(state.contentId);
                            // Chamamos a renderSeasonsModal após o conteúdo ser carregado
                            // O modal será aberto automaticamente no final do fetchAndRenderDetailsPage
                        } else if (state.modalType === 'episodes') {
                            fetchAndRenderDetailsPage(state.contentId).then(() => {
                                renderEpisodesModal(currentContent, state.data.season, state.data.seasonNumber);
                            });
                        }
                    }
                } catch (e) {
                    console.error("Não foi possível restaurar o estado do modal.", e);
                    localStorage.removeItem('modalState');
                }
            }
            window.addEventListener('popstate', restoreModalState);


            function renderSeasonsModal(content) {
                linksModalTitle.textContent = `Temporadas de ${content.title}`;
                linksModalContent.innerHTML = '';
                
                content.links.sort((a, b) => {
                    const titleA = a.title || '';
                    const titleB = b.title || '';
                    const numA = parseInt(titleA.match(/\d+/)) || 0;
                    const numB = parseInt(titleB.match(/\d+/)) || 0;
                    return numA - numB;
                }).forEach((seasonObj, seasonIndex) => {
                    const seasonBtn = document.createElement('button');
                    seasonBtn.textContent = seasonObj.title || `Temporada ${seasonIndex + 1}`;
                    seasonBtn.className = 'w-full py-2 bg-gray-700 text-white rounded-xl font-semibold hover:bg-gray-600 transition-colors';
                    seasonBtn.addEventListener('click', () => {
                        renderEpisodesModal(content, seasonObj, seasonIndex + 1);
                        saveModalState('episodes', content.id, { season: seasonObj, seasonNumber: seasonIndex + 1 });
                    });
                    linksModalContent.appendChild(seasonBtn);
                });
                linksModal.classList.add('active');
            }

            function renderEpisodesModal(content, seasonObj, seasonNumber) {
                linksModalTitle.textContent = `Episódios da Temporada ${seasonNumber}`;
                linksModalContent.innerHTML = '';
                const episodeStorageKey = `watched_episodes_${content.id}_${seasonNumber}`;
                let watchedEpisodes = JSON.parse(localStorage.getItem(episodeStorageKey)) || {};

                const backBtn = document.createElement('button');
                backBtn.textContent = "Voltar para Temporadas";
                backBtn.className = 'w-full py-2 mb-4 bg-gray-500 text-white rounded-xl font-semibold hover:bg-gray-600 transition-colors';
                backBtn.addEventListener('click', () => {
                     renderSeasonsModal(content);
                     saveModalState('seasons', content.id, null);
                });
                linksModalContent.appendChild(backBtn);

                seasonObj.episodes.sort((a, b) => {
                    const numA = parseInt(a.episodeNumber) || 0;
                    const numB = parseInt(b.episodeNumber) || 0;
                    return numA - numB;
                }).forEach((episode, episodeIndex) => {
                    const isWatched = watchedEpisodes[episode.url];
                    const eyeIconClass = isWatched ? 'fa-eye text-green-500' : 'fa-eye-slash text-gray-400';
                    const epText = `Episódio ${episode.episodeNumber || (episodeIndex + 1)}${episode.quality || episode.language ? ` (${[episode.quality, episode.language].filter(Boolean).join(', ')})` : ''}`;
                    
                    const episodeBtn = document.createElement('div');
                    episodeBtn.className = 'relative flex items-center bg-gray-700 text-white rounded-xl font-semibold transition-colors pr-10';
                    episodeBtn.innerHTML = `
                        <button data-url="${episode.url}" class="flex-1 py-2 px-4 text-left hover:bg-gray-600 rounded-l-xl">
                            ${epText}
                        </button>
                        <button class="toggle-watched-btn absolute right-0 top-0 h-full w-10 flex items-center justify-center hover:bg-gray-500 rounded-r-xl" data-url="${episode.url}" aria-label="Marcar episódio como assistido">
                            <i class="fa-solid ${eyeIconClass}" aria-hidden="true"></i>
                        </button>
                    `;
                    
                    episodeBtn.querySelector('button.flex-1').addEventListener('click', () => {
                        window.open(episode.url, '_blank');
                        // Marca o episódio como visto automaticamente
                        watchedEpisodes[episode.url] = true;
                        localStorage.setItem(episodeStorageKey, JSON.stringify(watchedEpisodes));
                        
                        const icon = episodeBtn.querySelector('.toggle-watched-btn i');
                        icon.classList.replace('fa-eye-slash', 'fa-eye');
                        icon.classList.replace('text-gray-400', 'text-green-500');
                    });

                    episodeBtn.querySelector('.toggle-watched-btn').addEventListener('click', (e) => {
                        const url = e.currentTarget.dataset.url;
                        const icon = e.currentTarget.querySelector('i');
                        if (watchedEpisodes[url]) {
                            delete watchedEpisodes[url];
                            icon.classList.replace('fa-eye', 'fa-eye-slash');
                            icon.classList.replace('text-green-500', 'text-gray-400');
                        } else {
                            watchedEpisodes[url] = true;
                            icon.classList.replace('fa-eye-slash', 'fa-eye');
                            icon.classList.replace('text-gray-400', 'text-green-500');
                        }
                        localStorage.setItem(episodeStorageKey, JSON.stringify(watchedEpisodes));
                    });
                    
                    linksModalContent.appendChild(episodeBtn);
                });
                linksModal.classList.add('active');
            }

            function renderNotifications(notifications) {
                notificationsList.innerHTML = '';
                if (notifications.length === 0) {
                    notificationsList.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">Nenhuma notificação nova.</p>`;
                    return;
                }
                notifications.forEach(notif => {
                    const notifItem = document.createElement('div');
                    notifItem.className = 'relative flex items-center space-x-4 p-2 bg-gray-100 dark:bg-zinc-700 rounded-xl cursor-pointer hover:bg-gray-200 dark:hover:bg-zinc-600 transition-colors notif-item';
                    notifItem.dataset.id = notif.id;
                    notifItem.dataset.contentId = notif.contentId;
                    const posterUrl = notif.poster_path ? `${IMAGE_BASE_URL}w92${notif.poster_path}` : 'https://placehold.co/92x138/cccccc/333333?text=N/A';
                    notifItem.innerHTML = `
                        <img src="${posterUrl}" alt="Pôster de ${notif.title}" class="w-12 h-18 rounded-xl object-cover">
                        <div class="flex-1">
                            <p class="font-bold text-sm">${notif.message}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${notif.timestamp ? new Date(notif.timestamp.seconds * 1000).toLocaleString() : 'agora'}</p>
                        </div>
                        <button class="remove-notification-btn text-gray-500 hover:text-red-500 p-1" data-id="${notif.id}">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    `;
                    notificationsList.appendChild(notifItem);
                });
            }

            function showTempMessage(message, isSuccess = true) {
                let messageDiv = document.getElementById('temp-message');
                if (!messageDiv) {
                    messageDiv = document.createElement('div');
                    messageDiv.id = 'temp-message';
                    messageDiv.className = 'notification-message';
                    document.body.appendChild(messageDiv);
                }
                messageDiv.textContent = message;
                messageDiv.style.backgroundColor = isSuccess ? '#22c55e' : '#ef4444';
                messageDiv.classList.add('visible');

                setTimeout(() => {
                    messageDiv.classList.remove('visible');
                }, 3000);
            }

            // --- Gerenciamento da Lista de Favoritos ---
            async function addToMyList(content) {
                const userListRef = auth.currentUser ? doc(db, `artifacts/${APP_ID}/users/${auth.currentUser.uid}/my_list`, content.id) : null;
                if (!userListRef) return;
                try {
                    await setDoc(userListRef, content);
                    showTempMessage("Conteúdo adicionado à sua lista!");
                } catch (error) {
                    console.error("Erro ao adicionar à lista:", error);
                    showTempMessage("Erro ao adicionar à lista. Verifique o console.", false);
                }
            }
            
            async function removeFromMyList(contentId) {
                const userListRef = auth.currentUser ? doc(db, `artifacts/${APP_ID}/users/${auth.currentUser.uid}/my_list`, contentId) : null;
                if (!userListRef) return;
                try {
                    await deleteDoc(userListRef);
                    showTempMessage("Conteúdo removido da sua lista!");
                    if (myListContent.classList.contains('hidden') === false) {
                        renderMyListPage();
                    }
                } catch (error) {
                    console.error("Erro ao remover da lista:", error);
                    showTempMessage("Erro ao remover da lista. Verifique o console.", false);
                }
            }
            
            // --- Lógica de Pesquisa do Catálogo ---
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                const searchQuery = e.target.value;
                clearSearchBtn.classList.toggle('hidden', searchQuery.length === 0);
                clearTimeout(searchTimeout);
                
                if (searchQuery.length > 2) {
                    searchTimeout = setTimeout(() => {
                        searchCatalog(searchQuery);
                        saveSearchQuery(searchQuery);
                    }, 500);
                } else if (searchQuery.length === 0) {
                     resultsContainer.innerHTML = '';
                     resultsContainer.classList.add('hidden');
                     featuredBanner.classList.remove('hidden');
                     releaseGridSection.classList.remove('hidden');
                     renderSearchHistory();
                     renderRecentSession();
                }
            });

            clearSearchBtn.addEventListener('click', () => {
                searchInput.value = '';
                clearSearchBtn.classList.add('hidden');
                loadHomePage();
            });

            function getSearchHistory() {
                try {
                    return JSON.parse(localStorage.getItem('searchHistory')) || [];
                } catch (e) {
                    console.error("Erro ao carregar histórico de busca.", e);
                    return [];
                }
            }
            
            function saveSearchQuery(searchQuery) {
                let history = getSearchHistory();
                const normalizedQuery = searchQuery.toLowerCase().trim();
                history = history.filter(item => item.toLowerCase().trim() !== normalizedQuery);
                history.unshift(searchQuery);
                if (history.length > 5) history.pop(); // Limita o histórico a 5 itens
                localStorage.setItem('searchHistory', JSON.stringify(history));
                renderSearchHistory();
            }

            function removeSearchQuery(searchQuery) {
                 let history = getSearchHistory();
                 history = history.filter(item => item !== searchQuery);
                 localStorage.setItem('searchHistory', JSON.stringify(history));
                 renderSearchHistory();
            }

            function renderSearchHistory() {
                const history = getSearchHistory();
                searchHistoryList.innerHTML = '';
                if (history.length > 0) {
                    searchHistoryContainer.classList.remove('hidden');
                    history.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center space-x-2 bg-gray-200 dark:bg-zinc-700 rounded-full pr-2';
                        div.innerHTML = `
                            <button class="px-3 py-1 text-sm rounded-full hover:bg-gray-300 dark:hover:bg-zinc-600 transition-colors search-history-item">${item}</button>
                            <button class="text-gray-500 hover:text-red-500 remove-history-item" data-query="${item}"><i class="fa-solid fa-xmark"></i></button>
                        `;
                        div.querySelector('.search-history-item').addEventListener('click', () => {
                            searchInput.value = item;
                            searchCatalog(item);
                        });
                        div.querySelector('.remove-history-item').addEventListener('click', (e) => {
                            removeSearchQuery(e.currentTarget.dataset.query);
                        });
                        searchHistoryList.appendChild(div);
                    });
                } else {
                    searchHistoryContainer.classList.add('hidden');
                }
            }

            async function searchCatalog(searchQuery) {
                scrollPositions[currentFilter] = window.scrollY; // Salva a posição antes de buscar
                showPage('main-content');
                resultsContainer.classList.remove('hidden');
                featuredBanner.classList.add('hidden');
                releaseGridSection.classList.add('hidden');
                resultsContainer.innerHTML = `<div class="flex items-center justify-center p-8">
                                                 <i class="fa-solid fa-spinner animate-spin mr-3 h-8 w-8 text-blue-500" aria-hidden="true"></i>
                                                 <p class="text-zinc-900 dark:text-white">Buscando...</p>
                                             </div>`;
                
                try {
                    const queryLowercase = searchQuery.toLowerCase().trim();
                    let querySnapshot;
                    try {
                        const q = query(collection(db, `artifacts/${APP_ID}/public/data/content`),
                            orderBy('title_lowercase'),
                            startAt(queryLowercase),
                            endAt(queryLowercase + '\uf8ff')
                        );
                        querySnapshot = await getDocs(q);
                    } catch (err) {
                        console.warn('Busca por prefix falhou, usando fallback.', err);
                        const qAll = query(collection(db, `artifacts/${APP_ID}/public/data/content`));
                        const allDocs = await getDocs(qAll);
                        const filteredDocs = allDocs.docs.filter(doc => (doc.data().title || '').toLowerCase().includes(queryLowercase));
                        querySnapshot = { docs: filteredDocs };
                    }
                    
                    resultsContainer.innerHTML = '';
                    if (querySnapshot && querySnapshot.docs.length > 0) {
                        resultsContainer.innerHTML = `<p class="text-sm text-gray-500 mb-6 text-xl font-semibold">${querySnapshot.docs.length} resultados encontrados</p>`;
                        querySnapshot.docs.forEach(doc => {
                            const item = { id: doc.id, ...doc.data() };
                            const posterUrl = item.poster_path ? `${IMAGE_BASE_URL}w500${item.poster_path}` : 'https://placehold.co/500x750/cccccc/333333?text=Sem+Pôster';
                            const resultElement = document.createElement('div');
                            resultElement.className = 'flex items-start space-x-4 p-4 bg-gray-50 dark:bg-zinc-800 rounded-2xl shadow-md transition-shadow hover:shadow-lg cursor-pointer';
                            resultElement.innerHTML = `
                                <img src="${posterUrl}" alt="Pôster de ${item.title}" class="w-24 h-36 rounded-xl object-cover">
                                <div class="flex-1">
                                    <h3 class="font-bold text-lg">${item.title} (${item.year})</h3>
                                    <p class="text-sm text-gray-700 dark:text-gray-300 mt-2 line-clamp-3">${item.synopsis}</p>
                                </div>
                            `;
                            resultElement.addEventListener('click', () => fetchAndRenderDetailsPage(item.id));
                            resultsContainer.appendChild(resultElement);
                        });
                    } else {
                        resultsContainer.innerHTML = '<p class="text-center text-red-500 dark:text-red-400">Nenhum resultado encontrado.</p>';
                    }
                } catch (error) {
                    console.error('Erro ao buscar filmes:', error);
                    resultsContainer.innerHTML = `<p class="text-red-500 text-center">Erro ao carregar resultados. Por favor, tente novamente.</p>`;
                }
            }


            // --- Funções do Novo Painel de Admin ---
            function renderAdminPanel() {
                showPage('admin-panel');
                // A UI do painel de admin já existe, apenas a tornamos visível
                const adminPanel = document.getElementById('admin-panel');
                if (adminPanel) adminPanel.classList.remove('hidden');

                // Listeners do painel de admin
                const showContentBtn = document.getElementById('show-content-btn');
                const showFeedbackBtn = document.getElementById('show-feedback-btn');
                const addContentBtn = document.getElementById('add-new-btn');
                const contentManagementSection = document.getElementById('content-management-section');
                const feedbackSection = document.getElementById('feedback-section');
                const contentFormSection = document.getElementById('content-form-section');
                const formTitle = document.getElementById('form-title');

                const tmdbSearchInput = document.getElementById('tmdb-search-input');
                const tmdbResults = document.getElementById('tmdb-results');
                const contentForm = document.getElementById('content-form');
                const contentTitle = document.getElementById('content-title');
                const contentSynopsis = document.getElementById('content-synopsis');
                const contentYear = document.getElementById('content-year');
                const contentGenres = document.getElementById('content-genres');
                const contentActors = document.getElementById('content-actors');
                const contentAward = document.getElementById('content-award');
                const contentPosterPath = document.getElementById('content-poster-path');
                const contentBackdropPath = document.getElementById('content-backdrop-path');
                const contentMediaType = document.getElementById('content-media-type');
                const movieLinksContainer = document.getElementById('movie-links-container');
                const movieLinksList = document.getElementById('movie-links-list');
                const addMovieLinkBtn = document.getElementById('add-movie-link-btn');
                const seriesLinksContainer = document.getElementById('series-links-container');
                const seasonsContainer = document.getElementById('seasons-container');
                const addSeasonBtn = document.getElementById('add-season-btn');
                const numSeasonsInput = document.getElementById('num-seasons-input');
                const generateSeasonsBtn = document.getElementById('generate-seasons-btn');
                let currentContentId = null;

                function resetForm() {
                    contentForm.reset();
                    movieLinksList.innerHTML = '';
                    seasonsContainer.innerHTML = '';
                    tmdbResults.innerHTML = '';
                    movieLinksContainer.classList.remove('hidden');
                    seriesLinksContainer.classList.add('hidden');
                    addMovieLinkField();
                    currentContentId = null;
                    formTitle.textContent = "Adicionar Novo Conteúdo";
                }
                
                showContentBtn.addEventListener('click', () => {
                    contentManagementSection.classList.remove('hidden');
                    feedbackSection.classList.add('hidden');
                    showContentBtn.classList.replace('bg-gray-500', 'bg-blue-500');
                    showFeedbackBtn.classList.replace('bg-blue-500', 'bg-gray-500');
                    addContentBtn.classList.replace('bg-gray-500', 'bg-green-500');
                });
                showFeedbackBtn.addEventListener('click', () => {
                    feedbackSection.classList.remove('hidden');
                    contentManagementSection.classList.add('hidden');
                    showFeedbackBtn.classList.replace('bg-gray-500', 'bg-blue-500');
                    showContentBtn.classList.replace('bg-blue-500', 'bg-gray-500');
                    addContentBtn.classList.replace('bg-green-500', 'bg-gray-500');
                });
                addContentBtn.addEventListener('click', () => {
                    contentManagementSection.classList.remove('hidden');
                    feedbackSection.classList.add('hidden');
                    showContentBtn.classList.replace('bg-gray-500', 'bg-blue-500');
                    showFeedbackBtn.classList.replace('bg-blue-500', 'bg-gray-500');
                    addContentBtn.classList.replace('bg-gray-500', 'bg-green-500');
                    resetForm();
                });

                // Funções de Gerenciamento de Links
                function createSelect(options, placeholder, name, value = '') {
                    const select = document.createElement('select');
                    select.name = name;
                    select.className = 'p-2 rounded-xl border dark:bg-zinc-600 flex-1';
                    select.innerHTML = `<option value="" disabled ${!value ? 'selected' : ''}>${placeholder}</option>`;
                    options.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option;
                        opt.textContent = option;
                        if (option === value) {
                            opt.selected = true;
                        }
                        select.appendChild(opt);
                    });
                    return select;
                }

                function addMovieLinkField(link = {}) {
                    const div = document.createElement('div');
                    div.className = 'flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0 p-2 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-zinc-700';
                    const qualitySelect = createSelect(QUALITIES, 'Qualidade', 'quality', link.quality);
                    const languageSelect = createSelect(LANGUAGES, 'Idioma', 'language', link.language);
                    const urlInput = document.createElement('input');
                    urlInput.type = 'url';
                    urlInput.name = 'url';
                    urlInput.placeholder = 'URL do Link';
                    urlInput.className = 'p-2 rounded-xl border dark:bg-zinc-600 flex-1';
                    urlInput.value = link.url || '';
                    urlInput.required = true;
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'remove-link-btn text-red-500 hover:text-red-700 transition-colors w-8 h-8';
                    removeBtn.innerHTML = '<i class="fa-solid fa-trash-can" aria-hidden="true"></i>';

                    div.appendChild(qualitySelect);
                    div.appendChild(languageSelect);
                    div.appendChild(urlInput);
                    div.appendChild(removeBtn);
                    movieLinksList.appendChild(div);
                }
                
                addMovieLinkBtn.addEventListener('click', () => addMovieLinkField());
                
                if (addSeasonBtn) {
                    addSeasonBtn.addEventListener('click', () => addSeasonField({}));
                }
                
                // Botão para gerar temporadas foi removido para evitar a perda de dados
                // if (generateSeasonsBtn) {
                //      generateSeasonsBtn.addEventListener('click', () => {
                //         const numSeasons = parseInt(numSeasonsInput.value, 10);
                //         if (numSeasons > 0) {
                //             seasonsContainer.innerHTML = '';
                //             for (let i = 1; i <= numSeasons; i++) {
                //                 addSeasonField({ title: `Temporada ${i}` });
                //             }
                //         }
                //     });
                // }

                function addSeasonField(season = {}) {
                    const seasonDiv = document.createElement('div');
                    seasonDiv.className = 'border-2 border-gray-400 p-4 rounded-2xl space-y-4';
                    
                    const seasonNumber = (seasonsContainer.children.length + 1);
                    const title = season.title || `Temporada ${seasonNumber}`;
                    const episodeCount = (season.episodes || []).length;
                    
                    const episodesList = document.createElement('div');
                    episodesList.className = 'space-y-2 episodes-list';

                    season.episodes?.forEach(episode => {
                        addEpisodeField(episodesList, episode);
                    });

                    seasonDiv.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <input type="text" name="season-title" placeholder="Nome da Temporada" class="p-2 rounded-xl border dark:bg-zinc-600 flex-1" value="${title}">
                            <button type="button" class="remove-season-btn text-red-500 hover:text-red-700 transition-colors w-8 h-8"><i class="fa-solid fa-trash-can" aria-hidden="true"></i></button>
                        </div>
                        <div class="space-y-2 episodes-container">
                            <h5 class="font-bold">Episódios</h5>
                            <div class="flex items-center space-x-2">
                                <input type="number" name="num-episodes" placeholder="Nº de Episódios" class="p-2 rounded-xl border dark:bg-zinc-700 w-full" value="${episodeCount}">
                                <button type="button" class="generate-episodes-btn px-4 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-colors">Gerar</button>
                            </div>
                            <div class="episodes-list space-y-2"></div>
                            <button type="button" class="add-episode-btn mt-2 w-full py-2 bg-purple-600 text-white rounded-xl hover:bg-purple-700 transition-colors">Adicionar Outro Episódio</button>
                        </div>
                    `;
                    seasonDiv.querySelector('.episodes-list').replaceWith(episodesList);
                    
                    const newEpisodesList = seasonDiv.querySelector('.episodes-list');
                    const generateEpisodesBtn = seasonDiv.querySelector('.generate-episodes-btn');
                    const numEpisodesInput = seasonDiv.querySelector('input[name="num-episodes"]');
                    const addEpisodeBtn = seasonDiv.querySelector('.add-episode-btn');
                    
                    if (numEpisodesInput) {
                        numEpisodesInput.addEventListener('change', () => {
                           newEpisodesList.innerHTML = '';
                           for (let i = 1; i <= numEpisodesInput.value; i++) {
                                addEpisodeField(newEpisodesList, { episodeNumber: i });
                           }
                        });
                    }

                    if(generateEpisodesBtn) {
                        generateEpisodesBtn.addEventListener('click', () => {
                            const numEpisodes = parseInt(numEpisodesInput.value, 10);
                            if (numEpisodes > 0) {
                                newEpisodesList.innerHTML = '';
                                for (let i = 1; i <= numEpisodes; i++) {
                                    addEpisodeField(newEpisodesList, { episodeNumber: i });
                                }
                            }
                        });
                    }

                    addEpisodeBtn.addEventListener('click', () => {
                        const nextEpisodeNumber = newEpisodesList.children.length + 1;
                        addEpisodeField(newEpisodesList, { episodeNumber: nextEpisodeNumber });
                    });
                    
                    seasonsContainer.appendChild(seasonDiv);
                }

                function addEpisodeField(container, episode = {}) {
                    const episodeDiv = document.createElement('div');
                    episodeDiv.className = 'flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0 p-2 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-zinc-700 episode-field';
                    
                    const qualitySelect = createSelect(QUALITIES, 'Qualidade', 'quality', episode.quality);
                    const languageSelect = createSelect(LANGUAGES, 'Idioma', 'language', episode.language);

                    const episodeNumberInput = document.createElement('input');
                    episodeNumberInput.type = 'text';
                    episodeNumberInput.name = 'episode-number';
                    episodeNumberInput.placeholder = 'Ep.';
                    episodeNumberInput.className = 'p-2 rounded-xl border dark:bg-zinc-600 w-12';
                    episodeNumberInput.value = episode.episodeNumber || '';
                    episodeNumberInput.readOnly = true;

                    const urlInput = document.createElement('input');
                    urlInput.type = 'url';
                    urlInput.name = 'url';
                    urlInput.placeholder = 'URL do Episódio';
                    urlInput.className = 'p-2 rounded-xl border dark:bg-zinc-600 flex-1';
                    urlInput.value = episode.url || '';
                    urlInput.required = true;
                    
                    urlInput.addEventListener('keydown', (e) => {
                         if (e.key === 'Enter') {
                             e.preventDefault();
                             const nextInput = urlInput.closest('.episode-field').nextElementSibling?.querySelector('input[name="url"]');
                             if (nextInput) {
                                 nextInput.focus();
                                 nextInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                             }
                           }
                    });


                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'remove-episode-btn text-red-500 hover:text-red-700 transition-colors w-8 h-8';
                    removeBtn.innerHTML = '<i class="fa-solid fa-trash-can" aria-hidden="true"></i>';

                    episodeDiv.appendChild(episodeNumberInput);
                    episodeDiv.appendChild(qualitySelect);
                    episodeDiv.appendChild(languageSelect);
                    episodeDiv.appendChild(urlInput);
                    episodeDiv.appendChild(removeBtn);
                    
                    container.appendChild(episodeDiv);
                }


                // Remover links e temporadas
                document.addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (target) {
                        if (target.classList.contains('remove-link-btn')) {
                            target.closest('div').remove();
                        } else if (target.classList.contains('remove-season-btn')) {
                            target.closest('.border-2').remove();
                        } else if (target.classList.contains('remove-episode-btn')) {
                            target.closest('.episode-field').remove();
                        } else if (target.classList.contains('remove-recent-btn')) {
                            const contentId = target.dataset.id;
                            removeRecentSessionItem(contentId);
                        }
                    }
                });

                async function addNotification(contentId, title, posterPath, message) {
                    try {
                        await addDoc(collection(db, `artifacts/${APP_ID}/public/data/notifications`), {
                            contentId: contentId,
                            title: title,
                            poster_path: posterPath,
                            message: message,
                            timestamp: serverTimestamp()
                        });
                        console.log("Notificação adicionada!");
                    } catch (error) {
                        console.error("Erro ao adicionar notificação:", error);
                    }
                }

                // Listener para TMDB search em tempo real
                let tmdbSearchTimeout;
                tmdbSearchInput.addEventListener('keyup', (e) => {
                    clearTimeout(tmdbSearchTimeout);
                    const searchQuery = e.target.value;
                    if (searchQuery.length > 2) {
                        tmdbSearchTimeout = setTimeout(() => {
                            searchTMDB(searchQuery);
                        }, 500);
                    } else if (searchQuery.length === 0) {
                        tmdbResults.innerHTML = '';
                    }
                });
                
                async function searchTMDB(searchQuery) {
                    tmdbResults.innerHTML = '<p class="text-center text-gray-500">Buscando...</p>';
                    try {
                        const response = await fetch(`https://api.themoviedb.org/3/search/multi?query=${searchQuery}&api_key=${TMDB_API_KEY}&language=pt-BR`);
                        const data = await response.json();
                        
                        tmdbResults.innerHTML = '';
                        if (data.results.length === 0) {
                            tmdbResults.innerHTML = '<p class="text-center text-red-500">Nenhum resultado encontrado.</p>';
                            return;
                        }

                        data.results.forEach(item => {
                            if (item.media_type === 'movie' || item.media_type === 'tv') {
                                const title = item.title || item.name;
                                const year = (item.release_date || item.first_air_date)?.substring(0, 4) || 'N/A';
                                const posterPath = item.poster_path ? `${IMAGE_BASE_URL}w500${item.poster_path}` : 'https://placehold.co/500x750/cccccc/333333?text=Sem+Pôster';
                                
                                const resultElement = document.createElement('div');
                                resultElement.className = 'flex items-center space-x-4 p-2 cursor-pointer hover:bg-gray-200 dark:hover:bg-zinc-700 rounded-xl transition-colors';
                                resultElement.innerHTML = `
                                    <img src="${posterUrl}" alt="Pôster de ${title}" class="w-12 h-18 rounded-xl">
                                    <div>
                                        <p class="font-bold">${title}</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">(${year})</p>
                                    </div>
                                `;
                                resultElement.addEventListener('click', () => {
                                    fillFormWithTMDBData(item.id, item.media_type);
                                    tmdbResults.innerHTML = ''; // Fecha a lista de resultados
                                });
                                tmdbResults.appendChild(resultElement);
                            }
                        });
                    } catch (error) {
                        console.error('Erro ao buscar TMDB:', error);
                        tmdbResults.innerHTML = '<p class="text-red-500 text-center">Erro ao buscar no TMDB. Tente novamente.</p>';
                    }
                }

                async function fillFormWithTMDBData(id, type) {
                    try {
                        const response = await fetch(`https://api.themoviedb.org/3/${type}/${id}?api_key=${TMDB_API_KEY}&language=pt-BR`);
                        const data = await response.json();

                        contentTitle.value = data.title || data.name;
                        contentSynopsis.value = data.overview;
                        contentYear.value = (data.release_date || data.first_air_date)?.substring(0, 4) || '';
                        contentGenres.value = data.genres?.map(g => g.name).join(', ') || 'N/A';
                        contentPosterPath.value = data.poster_path;
                        contentBackdropPath.value = data.backdrop_path;
                        contentMediaType.value = type;
                        contentAward.value = '';
                        currentContentId = id.toString(); // Usa o ID do TMDB como ID do Firestore

                        const creditsResponse = await fetch(`https://api.themoviedb.org/3/${type}/${id}/credits?api_key=${TMDB_API_KEY}&language=pt-BR`);
                        const creditsData = await creditsResponse.json();
                        contentActors.value = creditsData.cast?.slice(0, 5).map(actor => actor.name).join(', ') || 'N/A';
                        
                        // Reseta e mostra os campos de link corretos
                        movieLinksList.innerHTML = '';
                        seasonsContainer.innerHTML = '';
                        if (type === 'movie') {
                            movieLinksContainer.classList.remove('hidden');
                            seriesLinksContainer.classList.add('hidden');
                            if (data.links && data.links.length > 0) {
                                data.links.forEach(link => addMovieLinkField(link));
                            } else {
                                addMovieLinkField();
                            }
                        } else {
                            seriesLinksContainer.classList.remove('hidden');
                            movieLinksContainer.classList.add('hidden');
                            if (data.links && data.links.length > 0) {
                                data.links.forEach(season => addSeasonField(season));
                            } else {
                                addSeasonField();
                            }
                        }
                        
                        formTitle.textContent = `Editando: ${data.title || data.name}`;

                    } catch (error) {
                        console.error('Erro ao buscar detalhes do TMDB:', error);
                    }
                }

                // Listener para salvar/atualizar conteúdo
                contentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    // Mostra barra de carregamento e desabilita botão
                    loadingBar.style.width = '50%';
                    publishBtn.disabled = true;

                    const mediaType = contentMediaType.value;
                    let links = [];
                    let oldContent = null;
                    let isUpdate = false;
                    let docRef;
                    let notificationMessage = `Novo conteúdo adicionado: ${contentTitle.value}`;

                    if (currentContentId) {
                          docRef = doc(db, `artifacts/${APP_ID}/public/data/content`, currentContentId);
                          const docSnap = await getDoc(docRef);
                          isUpdate = docSnap.exists();
                          if(isUpdate) {
                              oldContent = docSnap.data();
                           }
                    } else {
                          docRef = doc(collection(db, `artifacts/${APP_ID}/public/data/content`));
                    }

                    // Prevenção de duplicatas
                    const existingContentQuery = query(collection(db, `artifacts/${APP_ID}/public/data/content`), where('title_lowercase', '==', contentTitle.value.toLowerCase()));
                    const existingContentSnap = await getDocs(existingContentQuery);
                    if (existingContentSnap.docs.length > 0 && existingContentSnap.docs[0].id !== docRef.id) {
                          showTempMessage('Um conteúdo com este título já existe. Edite-o ou use um título diferente.', false);
                          loadingBar.style.width = '0';
                          publishBtn.disabled = false;
                          return;
                    }


                    if (mediaType === 'movie') {
                        const linkInputs = movieLinksList.querySelectorAll('div');
                        links = Array.from(linkInputs).map(div => {
                            const quality = div.querySelector('select[name="quality"]').value;
                            const language = div.querySelector('select[name="language"]').value;
                            const url = div.querySelector('input[name="url"]').value;
                            return { quality, language, url };
                        }).filter(link => link.url);
                        
                        if (isUpdate) {
                            if (JSON.stringify(oldContent.links) !== JSON.stringify(links)) {
                                notificationMessage = `Links atualizados para: ${contentTitle.value}`;
                            } else {
                                notificationMessage = `Conteúdo atualizado: ${contentTitle.value}`;
                            }
                        }
                        
                    } else if (mediaType === 'tv') {
                        const seasonDivs = seasonsContainer.querySelectorAll('.border-2');
                        links = Array.from(seasonDivs).map(seasonDiv => {
                            const seasonTitle = seasonDiv.querySelector('input[name="season-title"]').value;
                            const episodeDivs = seasonDiv.querySelectorAll('.episodes-list .episode-field');
                            const episodes = Array.from(episodeDivs).map(episodeDiv => {
                                const episodeNumber = episodeDiv.querySelector('input[name="episode-number"]').value;
                                const quality = episodeDiv.querySelector('select[name="quality"]').value;
                                const language = episodeDiv.querySelector('select[name="language"]').value;
                                const url = episodeDiv.querySelector('input[name="url"]').value;
                                return { episodeNumber, title: `Episódio ${episodeNumber}`, quality, language, url, timestamp: serverTimestamp() };
                            }).filter(episode => episode.url);

                            return { title: seasonTitle, episodes: episodes, timestamp: serverTimestamp() };
                        }).filter(season => season.episodes.length > 0);
                        
                        if(isUpdate) {
                            const oldSeasons = oldContent.links || [];
                            const newSeasons = links || [];
                            if (newSeasons.length > oldSeasons.length) {
                                notificationMessage = `Nova temporada adicionada: ${contentTitle.value}`;
                            } else if (JSON.stringify(newSeasons) !== JSON.stringify(oldSeasons)) {
                                // Check if new episodes were added
                                const oldEpisodeCount = oldSeasons.reduce((acc, season) => acc + (season.episodes?.length || 0), 0);
                                const newEpisodeCount = newSeasons.reduce((acc, season) => acc + (season.episodes?.length || 0), 0);
                                if (newEpisodeCount > oldEpisodeCount) {
                                    const newEpisodes = newSeasons.flatMap(s => s.episodes).filter(ne => !oldSeasons.some(os => os.episodes.some(oe => oe.url === ne.url)));
                                    const newEpisodeNumbers = newEpisodes.map(ep => ep.episodeNumber).filter(Boolean);
                                    if(newEpisodeNumbers.length > 0) {
                                        notificationMessage = `Novos episódios adicionados: ${newEpisodeNumbers.join(', ')} de ${contentTitle.value}`;
                                    } else {
                                        notificationMessage = `Episódios atualizados para: ${contentTitle.value}`;
                                    }
                                } else {
                                    notificationMessage = `Conteúdo atualizado: ${contentTitle.value}`;
                                }
                            }
                        }
                    }

                    const contentData = {
                        title: contentTitle.value,
                        title_lowercase: contentTitle.value.toLowerCase(), // Campo para busca otimizada
                        synopsis: contentSynopsis.value,
                        year: contentYear.value,
                        genres: contentGenres.value.split(',').map(s => s.trim()),
                        actors: contentActors.value.split(',').map(s => s.trim()),
                        award: contentAward.value || null,
                        poster_path: contentPosterPath.value,
                        backdrop_path: contentBackdropPath.value,
                        links: links,
                        media_type: mediaType,
                        timestamp: serverTimestamp()
                    };
                    
                    try {
                        await setDoc(doc(db, `artifacts/${APP_ID}/public/data/content`, currentContentId || doc().id), contentData, { merge: true });
                        console.log("Conteúdo publicado/atualizado com sucesso!");
                        if (!isUpdate || (oldContent && JSON.stringify(oldContent) !== JSON.stringify(contentData))) {
                              addNotification(docRef.id, contentTitle.value, contentPosterPath.value, notificationMessage);
                        }
                        resetForm();
                        showTempMessage("Conteúdo publicado com sucesso!");
                    } catch (error) {
                        console.error("Erro ao salvar conteúdo:", error);
                        showTempMessage("Erro ao publicar conteúdo. Verifique o console.", false);
                    } finally {
                        // Esconde barra de carregamento e reabilita botão
                        loadingBar.style.width = '100%';
                        setTimeout(() => {
                           loadingBar.style.width = '0';
                           publishBtn.disabled = false;
                        }, 500);
                    }
                });

                // Lógica de busca na área admin
                adminSearchInput.addEventListener('keyup', () => {
                    const searchTerm = adminSearchInput.value.toLowerCase();
                    const listItems = document.querySelectorAll('#content-list li');
                    listItems.forEach(item => {
                        const title = item.querySelector('span').textContent.toLowerCase();
                        if (title.includes(searchTerm)) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });

                // Listener para editar e excluir conteúdo
                document.addEventListener('click', async (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    const id = button.dataset.id;
                    
                    if (button.classList.contains('delete-btn')) {
                         if(id) {
                            contentToDelete = id;
                            confirmationModal.classList.add('active');
                         }
                    } else if (button.classList.contains('edit-btn')) {
                        const docRef = doc(db, `artifacts/${APP_ID}/public/data/content`, id);
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            contentTitle.value = data.title;
                            contentSynopsis.value = data.synopsis;
                            contentYear.value = data.year;
                            contentGenres.value = (data.genres || []).join(', ');
                            contentActors.value = (data.actors || []).join(', ');
                            contentAward.value = data.award || '';
                            contentPosterPath.value = data.poster_path;
                            contentBackdropPath.value = data.backdrop_path;
                            contentMediaType.value = data.media_type;
                            currentContentId = id;

                            movieLinksList.innerHTML = '';
                            seasonsContainer.innerHTML = '';
                            if (data.media_type === 'movie') {
                                movieLinksContainer.classList.remove('hidden');
                                seriesLinksContainer.classList.add('hidden');
                                if (data.links && data.links.length > 0) {
                                    data.links.forEach(link => addMovieLinkField(link));
                                } else {
                                    addMovieLinkField();
                                }
                            } else {
                                seriesLinksContainer.classList.remove('hidden');
                                movieLinksContainer.classList.add('hidden');
                                if (data.links && data.links.length > 0) {
                                    data.links.forEach(season => addSeasonField(season));
                                } else {
                                    addSeasonField();
                                }
                            }
                            formTitle.textContent = `Editando: ${data.title}`;
                        }
                    } else if (button.classList.contains('delete-feedback-btn')) {
                        try {
                            await deleteDoc(doc(db, `artifacts/${APP_ID}/public/data/feedbacks`, id));
                            console.log("Feedback excluído!");
                            showTempMessage("Feedback excluído com sucesso!");
                        } catch (error) {
                            console.error("Erro ao excluir feedback:", error);
                            showTempMessage("Erro ao excluir feedback. Verifique o console.", false);
                        }
                    } else if (button.classList.contains('remove-from-list-btn')) {
                        contentToRemoveFromList = button.dataset.id;
                        myListDeleteModal.classList.add('active');
                    } else if (button.classList.contains('remove-notification-btn')) {
                           try {
                             await deleteDoc(doc(db, `artifacts/${APP_ID}/public/data/notifications`, id));
                             showTempMessage("Notificação removida!");
                           } catch (error) {
                             console.error("Erro ao remover notificação:", error);
                             showTempMessage("Erro ao remover notificação. Verifique o console.", false);
                           }
                    }
                });
                
                // My List removal modals
                confirmRemoveFromListBtn.addEventListener('click', async () => {
                    if (contentToRemoveFromList) {
                        await removeFromMyList(contentToRemoveFromList);
                        myListDeleteModal.classList.remove('active');
                        contentToRemoveFromList = null;
                    }
                });
                cancelRemoveFromListBtn.addEventListener('click', () => {
                    myListDeleteModal.classList.remove('active');
                    contentToRemoveFromList = null;
                });
                
                clearMyListBtn.addEventListener('click', () => {
                    clearMyListModal.classList.add('active');
                });
                
                confirmClearListBtn.addEventListener('click', async () => {
                    if (auth.currentUser) {
                        const myListRef = collection(db, `artifacts/${APP_ID}/users/${auth.currentUser.uid}/my_list`);
                        const querySnapshot = await getDocs(myListRef);
                        const deletePromises = [];
                        querySnapshot.forEach(doc => {
                            deletePromises.push(deleteDoc(doc.ref));
                        });
                        await Promise.all(deletePromises);
                        showTempMessage("Todos os conteúdos foram removidos da sua lista!");
                        renderMyListPage();
                    }
                    clearMyListModal.classList.remove('active');
                });
                
                cancelClearListBtn.addEventListener('click', () => {
                    clearMyListModal.classList.remove('active');
                });


                confirmDeleteButton.addEventListener('click', async () => {
                    if (contentToDelete) {
                        try {
                            await deleteDoc(doc(db, `artifacts/${APP_ID}/public/data/content`, contentToDelete));
                            console.log("Conteúdo excluído!");
                            showTempMessage("Conteúdo excluído com sucesso!");
                        } catch (error) {
                            console.error("Erro ao excluir conteúdo:", error);
                            showTempMessage("Erro ao excluir conteúdo. Verifique o console.", false);
                        }
                        confirmationModal.classList.remove('active');
                        contentToDelete = null;
                    }
                });

                cancelDeleteButton.addEventListener('click', () => {
                    confirmationModal.classList.remove('active');
                    contentToDelete = null;
                });
                
                // Listener para clicar em uma notificação
                document.addEventListener('click', async (e) => {
                    const notifItem = e.target.closest('.notif-item');
                    const removeBtn = e.target.closest('.remove-notification-btn');

                    if (notifItem && !removeBtn) {
                        const notifId = notifItem.dataset.id;
                        const contentId = notifItem.dataset.contentId;
                        try {
                             // Delete notification after clicking on it to see the content
                             await deleteDoc(doc(db, `artifacts/${APP_ID}/public/data/notifications`, notifId));
                             notificationsModal.classList.remove('active');
                             fetchAndRenderDetailsPage(contentId);
                        } catch (error) {
                            console.error("Erro ao marcar notificação como lida:", error);
                        }
                    }
                });
            }

            // --- Gerenciamento de Modal e Event Listeners Gerais ---
            myListLink.addEventListener('click', (e) => {
                e.preventDefault();
                closeMenu();
                renderMyListPage();
            });

            myListSortSelect.addEventListener('change', () => {
                renderMyListPage();
            });

            // Funções de Tema
            function toggleTheme() {
                const isDark = html.classList.toggle('dark');
                const icon = themeToggle.querySelector('i');
                if (isDark) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                    icon.setAttribute('aria-label', 'Alternar para tema claro');
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                    icon.setAttribute('aria-label', 'Alternar para tema escuro');
                }
            }
            themeToggle.addEventListener('click', toggleTheme);

            // Funções do Menu Lateral
            function openMenu() {
                sideMenuContainer.classList.remove('hidden');
                setTimeout(() => sideMenu.classList.add('visible'), 10);
            }
            function closeMenu() {
                sideMenu.classList.remove('visible');
                setTimeout(() => sideMenuContainer.classList.add('hidden'), 300);
            }
            menuButton.addEventListener('click', openMenu);
            closeMenuButton.addEventListener('click', closeMenu);
            sideMenuContainer.addEventListener('click', (event) => {
                if (event.target === sideMenuContainer) {
                    closeMenu();
                }
            });

            // Lógica para o clique no título CINERAVE
            appTitle.addEventListener('click', (e) => {
                // Remove o comportamento padrão para que não recarregue a página
                e.preventDefault();
                // Não faz nada, como solicitado
            });
            
            // Adicionado listener para o botão de voltar da página de detalhes
            window.addEventListener('popstate', (e) => {
                const urlParams = new URLSearchParams(window.location.search);
                const page = urlParams.get('page');
                const id = urlParams.get('id');

                if (page === 'details' && id) {
                    // Restaurar o estado do modal se necessário
                    restoreModalState();
                } else if (page === 'catalog') {
                    renderCatalogPage();
                } else if (page === 'my-list') {
                    renderMyListPage();
                } else {
                    loadHomePage();
                }
            });

            // Lidar com a rolagem para carregar mais conteúdo
            window.addEventListener('scroll', () => {
                const isAtBottom = (window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500;
                
                if(isAtBottom) {
                    if (mainContent.classList.contains('hidden') === false && currentFilter === 'home' && lastVisibleHome !== 'end' && loadingSpinnerHome.classList.contains('hidden')) {
                         loadMainContent(lastVisibleHome);
                    } else if (catalogContent.classList.contains('hidden') === false && lastVisibleCatalog !== 'end' && loadingSpinnerCatalog.classList.contains('hidden')) {
                         loadFullCatalog(lastVisibleCatalog);
                    }
                }
            });
            
            loadMoreHomeBtn.addEventListener('click', () => loadMainContent(lastVisibleHome));
            loadMoreCatalogBtn.addEventListener('click', () => loadFullCatalog(lastVisibleCatalog, catalogFilters));


            // Listener para o botão de "Assistir Agora" no banner
            document.addEventListener('click', (e) => {
                if (e.target.closest('.watch-now-btn')) {
                    const contentId = e.target.closest('.watch-now-btn').dataset.id;
                    if (contentId) {
                        fetchAndRenderDetailsPage(contentId);
                    }
                }
            });

            closeLinksModal.addEventListener('click', () => {
                linksModal.classList.remove('active');
                localStorage.removeItem('modalState'); // Limpa o estado ao fechar manualmente
            });
            
            // Adicionado listener para cliques nos cards da coleção dinâmica
            document.addEventListener('click', (e) => {
                const card = e.target.closest('.scrolling-wrapper .content-card');
                if (card) {
                    const contentId = card.dataset.id;
                    if (contentId) {
                        fetchAndRenderDetailsPage(contentId);
                    }
                }
            });


            // Lidar com o clique no link de início
            document.getElementById('home-link').addEventListener('click', (e) => {
                e.preventDefault();
                closeMenu();
                loadHomePage();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            
            // Lidar com o clique no link de catálogo
            document.getElementById('catalog-link').addEventListener('click', (e) => {
                e.preventDefault();
                closeMenu();
                renderCatalogPage();
            });
            
            // Lidar com o botão de notificações
            notificationsBtn.addEventListener('click', () => {
                notificationsModal.classList.add('active');
            });

            closeNotificationsModal.addEventListener('click', () => {
                notificationsModal.classList.remove('active');
            });
            
            // Lógica de busca no catálogo
            let catalogSearchTimeout;
            catalogSearchInput.addEventListener('input', (e) => {
                clearTimeout(catalogSearchTimeout);
                const searchQuery = e.target.value.toLowerCase();
                catalogSearchTimeout = setTimeout(() => {
                    const cards = fullCatalogGrid.querySelectorAll('.content-card');
                    let count = 0;
                    cards.forEach(card => {
                        const title = card.querySelector('h4').textContent.toLowerCase();
                        if (title.includes(searchQuery)) {
                            card.style.display = 'block';
                            count++;
                        } else {
                            card.style.display = 'none';
                        }
                    });
                    catalogCountSpan.textContent = count;
                }, 300);
            });


            // Lógica do botão de "Subir para o Topo"
            window.addEventListener('scroll', () => {
                if (mainContent.classList.contains('hidden')) {
                    scrollToTopBtn.classList.add('opacity-0', 'invisible');
                } else {
                    if (window.scrollY > 300) {
                        scrollToTopBtn.classList.remove('opacity-0', 'invisible');
                        scrollToTopBtn.classList.add('opacity-100', 'visible');
                    } else {
                        scrollToTopBtn.classList.remove('opacity-100', 'visible');
                        scrollToTopBtn.classList.add('opacity-0', 'invisible');
                    }
                }
            });

            scrollToTopBtn.addEventListener('click', () => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
            
            // Navegação rápida
            navHomeBtn.addEventListener('click', () => filterAndRenderContent('home'));
            navSeriesBtn.addEventListener('click', () => filterAndRenderContent('series'));
            navTrendingBtn.addEventListener('click', () => filterAndRenderContent('trending'));

            // Botões do novo menu
            surpriseMeLink.addEventListener('click', (e) => {
                e.preventDefault();
                closeMenu();
                if (allContent.length > 0) {
                    const randomIndex = Math.floor(Math.random() * allContent.length);
                    const randomContent = allContent[randomIndex];
                    fetchAndRenderDetailsPage(randomContent.id);
                } else {
                    showTempMessage("O catálogo está vazio. Tente novamente mais tarde.", false);
                }
            });
            
            legalNoticeLink.addEventListener('click', (e) => {
                e.preventDefault();
                closeMenu();
                legalNoticeModal.classList.add('active');
            });
            
            closeLegalNoticeModal.addEventListener('click', () => {
                legalNoticeModal.classList.remove('active');
            });
            
            // Lógica para o botão de "Doação"
            const donationLink = document.querySelector('a[href="https://livepix.gg/cinerave"]');
            donationLink.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            // Funções do Modal de Feedback
            reportErrorLink.addEventListener('click', (e) => {
                e.preventDefault();
                closeMenu();
                feedbackModal.classList.add('active');
            });
            closeFeedbackModal.addEventListener('click', () => {
                feedbackModal.classList.remove('active');
            });
            submitFeedbackButton.addEventListener('click', async () => {
                const feedbackType = document.querySelector('input[name="feedback-type"]:checked')?.value || 'Nenhum';
                const message = feedbackMessageInput.value;

                if (!message) {
                    console.error("Mensagem de feedback não pode ser vazia.");
                    return;
                }

                try {
                    await addDoc(collection(db, `artifacts/${APP_ID}/public/data/feedbacks`), {
                        type: feedbackType,
                        message: message,
                        timestamp: serverTimestamp()
                    });
                    console.log("Feedback enviado!");
                    feedbackModal.classList.remove('active');
                    feedbackMessageInput.value = '';
                    showTempMessage("Feedback enviado com sucesso!");
                } catch (error) {
                    console.error("Erro ao enviar feedback:", error);
                    showTempMessage("Erro ao enviar feedback. Verifique o console.", false);
                }
            });

            // Funções do Modal de Admin
            adminLoginLink.addEventListener('click', (e) => {
                e.preventDefault();
                closeMenu();
                adminLoginModal.classList.add('active');
            });
            closeAdminLoginModal.addEventListener('click', () => {
                adminLoginModal.classList.remove('active');
                adminPasswordInput.value = '';
                adminLoginError.classList.add('hidden');
            });
            adminLoginButton.addEventListener('click', () => {
                if (adminPasswordInput.value === 'leoleo') {
                    isAdmin = true;
                    adminLoginModal.classList.remove('active');
                    adminLoginError.classList.add('hidden');
                    renderAdminPanel();
                    showTempMessage("Acesso de administrador liberado!");
                    
                    // Re-renderizar as grades para mostrar os botões de admin
                    if(allContent && allContent.length > 0) {
                        contentGrid.innerHTML = '';
                        fullCatalogGrid.innerHTML = '';
                        allContent.forEach(content => {
                            renderContentCard(content, contentGrid);
                            renderContentCard(content, fullCatalogGrid);
                        });
                    }
                } else {
                    adminLoginError.classList.remove('hidden');
                }
            });
        });
    </script>
</body>
</html>
